<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public Safety Pulse ‚Äî City Science Lab SF √ó MIT Media Lab</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300;1,9..40,400&family=DM+Mono:wght@300;400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,600;0,9..144,700;1,9..144,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #0a0e1a;
  --bg-card: #111827;
  --bg-card-alt: #151d30;
  --bg-surface: #1a2340;
  --border: #1e2d4a;
  --text-primary: #e8edf5;
  --text-secondary: #8a9bc0;
  --text-muted: #5a6a8a;
  --accent-blue: #3b82f6;
  --accent-cyan: #06b6d4;
  --accent-green: #10b981;
  --accent-amber: #f59e0b;
  --accent-red: #ef4444;
  --accent-purple: #8b5cf6;
  --gradient-warm: linear-gradient(135deg, #ef4444 0%, #f59e0b 100%);
  --gradient-cool: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
  --gradient-safety: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
  --font-body: 'DM Sans', system-ui, sans-serif;
  --font-display: 'Fraunces', Georgia, serif;
  --font-mono: 'DM Mono', 'Menlo', monospace;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-body);
  background: var(--bg-deep);
  color: var(--text-primary);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* ===== HEADER ===== */
.site-header {
  background: linear-gradient(180deg, rgba(10,14,26,0.97) 0%, rgba(10,14,26,0.92) 100%);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 1000;
  padding: 0 24px;
}

.header-inner {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

.brand-icon {
  width: 36px;
  height: 36px;
  background: var(--gradient-safety);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  color: white;
  letter-spacing: -1px;
}

.brand-text {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  letter-spacing: -0.3px;
}

.brand-sub {
  font-family: var(--font-body);
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 400;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* ===== NAVIGATION ===== */
.nav-tabs {
  display: flex;
  gap: 2px;
  overflow-x: auto;
  scrollbar-width: none;
}
.nav-tabs::-webkit-scrollbar { display: none; }

.nav-tab {
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  cursor: pointer;
  border: none;
  background: none;
  white-space: nowrap;
  border-bottom: 2px solid transparent;
  transition: all 0.2s ease;
  font-family: var(--font-body);
}

.nav-tab:hover { color: var(--text-secondary); }

.nav-tab.active {
  color: var(--accent-cyan);
  border-bottom-color: var(--accent-cyan);
}

/* ===== MAIN CONTENT ===== */
.main-content {
  max-width: 1400px;
  margin: 0 auto;
  padding: 32px 24px 80px;
}

.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ===== CARDS ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 28px;
  margin-bottom: 20px;
}

.card-glass {
  background: rgba(17, 24, 39, 0.7);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(59, 130, 246, 0.15);
}

.section-title {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 600;
  letter-spacing: -0.5px;
  margin-bottom: 8px;
  line-height: 1.2;
}

.section-subtitle {
  font-size: 15px;
  color: var(--text-secondary);
  margin-bottom: 24px;
  max-width: 680px;
}

/* ===== STAT CARDS ===== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
}

.stat-card.red::before { background: var(--gradient-warm); }
.stat-card.blue::before { background: var(--gradient-cool); }
.stat-card.green::before { background: var(--accent-green); }
.stat-card.amber::before { background: var(--accent-amber); }
.stat-card.purple::before { background: var(--accent-purple); }

.stat-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.stat-value {
  font-family: var(--font-display);
  font-size: 32px;
  font-weight: 700;
  letter-spacing: -1px;
}

.stat-note {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 4px;
}

/* ===== MAP ===== */
#map-container {
  height: 520px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border);
  position: relative;
}

.map-controls {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  align-items: center;
}

.map-select {
  padding: 8px 14px;
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: var(--font-body);
  font-size: 13px;
  cursor: pointer;
}

.map-legend {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: rgba(10,14,26,0.92);
  backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  z-index: 500;
  font-size: 12px;
}

.legend-bar {
  width: 180px;
  height: 12px;
  border-radius: 6px;
  background: linear-gradient(90deg, #ef4444, #f59e0b, #84cc16, #10b981);
  margin: 6px 0;
}

.legend-labels {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-muted);
}

/* ===== BAR CHART ===== */
.bar-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 0;
  border-bottom: 1px solid rgba(30,45,74,0.3);
}

.bar-label {
  width: 160px;
  font-size: 13px;
  color: var(--text-secondary);
  flex-shrink: 0;
  text-align: right;
}

.bar-track {
  flex: 1;
  height: 24px;
  background: rgba(26,35,64,0.5);
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}

.bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.bar-ci {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  height: 8px;
  background: rgba(255,255,255,0.15);
  border-radius: 4px;
  border-left: 2px solid rgba(255,255,255,0.4);
  border-right: 2px solid rgba(255,255,255,0.4);
}

.bar-value {
  width: 80px;
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-secondary);
  flex-shrink: 0;
}

/* ===== QUADRANT ===== */
.quadrant-container {
  position: relative;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
}

.quadrant-canvas {
  width: 100%;
  aspect-ratio: 4/3;
  display: block;
}

.quadrant-legend {
  display: flex;
  gap: 24px;
  justify-content: center;
  margin-top: 16px;
  flex-wrap: wrap;
}

.q-legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-secondary);
}

.q-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

/* ===== FEATURE IMPORTANCE ===== */
.fi-bar-container {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 8px 0;
}

.fi-label {
  width: 180px;
  font-size: 13px;
  color: var(--text-secondary);
  text-align: right;
  flex-shrink: 0;
}

.fi-bar {
  flex: 1;
  height: 20px;
  background: rgba(26,35,64,0.5);
  border-radius: 4px;
  overflow: hidden;
}

.fi-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.6s ease;
}

.fi-value {
  width: 50px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
}

/* ===== AI VISION ===== */
.phase-timeline {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

.phase-card {
  background: var(--bg-card-alt);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  position: relative;
  overflow: hidden;
}

.phase-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
}

.phase-card.current::before { background: var(--accent-cyan); }
.phase-card.next::before { background: var(--accent-purple); }
.phase-card.future::before { background: var(--accent-green); }

.phase-tag {
  display: inline-block;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 4px;
  margin-bottom: 12px;
}

.phase-tag.current { background: rgba(6,182,212,0.15); color: var(--accent-cyan); }
.phase-tag.next { background: rgba(139,92,246,0.15); color: var(--accent-purple); }
.phase-tag.future { background: rgba(16,185,129,0.15); color: var(--accent-green); }

.phase-title {
  font-family: var(--font-display);
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 8px;
}

.phase-desc {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.tech-pill {
  display: inline-block;
  font-size: 11px;
  padding: 3px 10px;
  background: rgba(59,130,246,0.1);
  border: 1px solid rgba(59,130,246,0.2);
  border-radius: 20px;
  color: var(--accent-blue);
  margin: 2px 4px 2px 0;
  font-family: var(--font-mono);
}

/* ===== DATA METHODS ===== */
.method-block {
  background: var(--bg-card-alt);
  border-left: 3px solid var(--accent-cyan);
  padding: 20px 24px;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  margin: 16px 0;
}

.method-block code {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--accent-cyan);
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  margin: 16px 0;
}

.data-table th {
  text-align: left;
  padding: 10px 14px;
  border-bottom: 2px solid var(--border);
  color: var(--text-muted);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.data-table td {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(30,45,74,0.3);
  color: var(--text-secondary);
}

.data-table tr:hover td { background: rgba(59,130,246,0.03); }

/* ===== QUOTE ===== */
.quote-block {
  border-left: 3px solid var(--accent-amber);
  padding: 20px 24px;
  background: rgba(245,158,11,0.04);
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  margin: 24px 0;
}

.quote-text {
  font-family: var(--font-display);
  font-size: 22px;
  font-weight: 300;
  font-style: italic;
  color: var(--text-primary);
  line-height: 1.5;
}

.quote-attr {
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 10px;
}

/* ===== GAP VISUAL ===== */
.gap-visual {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 40px;
  margin: 32px 0;
  flex-wrap: wrap;
}

.gap-circle {
  width: 140px;
  height: 140px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.gap-circle .value {
  font-family: var(--font-display);
  font-size: 36px;
  font-weight: 700;
}

.gap-circle .label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-top: 2px;
}

.gap-arrow {
  font-size: 28px;
  color: var(--text-muted);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .header-inner { flex-direction: column; height: auto; padding: 12px 0; gap: 8px; }
  .nav-tabs { width: 100%; }
  .main-content { padding: 16px 12px 60px; }
  .card { padding: 18px; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .section-title { font-size: 22px; }
  .bar-label { width: 100px; font-size: 11px; }
  #map-container { height: 360px; }
  .gap-visual { gap: 16px; }
  .gap-circle { width: 110px; height: 110px; }
  .gap-circle .value { font-size: 28px; }
}

/* ===== ANIMATIONS ===== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(16px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-in {
  animation: fadeInUp 0.5s ease forwards;
  opacity: 0;
}

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }
.delay-4 { animation-delay: 0.4s; }

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-deep); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #2a3d60; }

/* ===== CTA SECTION ===== */
.cta-card {
  background: linear-gradient(135deg, rgba(59,130,246,0.12) 0%, rgba(139,92,246,0.12) 100%);
  border: 1px solid rgba(59,130,246,0.25);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
}

.cta-title {
  font-family: var(--font-display);
  font-size: 32px;
  font-weight: 600;
  margin-bottom: 12px;
}

.cta-text {
  font-size: 16px;
  color: var(--text-secondary);
  max-width: 600px;
  margin: 0 auto 24px;
}

.cta-btn {
  display: inline-block;
  padding: 12px 32px;
  background: var(--gradient-cool);
  color: white;
  font-weight: 600;
  font-size: 15px;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--font-body);
  text-decoration: none;
  transition: transform 0.2s, box-shadow 0.2s;
}

.cta-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 24px rgba(59,130,246,0.3);
}

/* ===== LEAFLET OVERRIDES ===== */
.leaflet-container { background: var(--bg-deep) !important; }
.leaflet-popup-content-wrapper {
  background: var(--bg-card) !important;
  color: var(--text-primary) !important;
  border: 1px solid var(--border) !important;
  border-radius: var(--radius-sm) !important;
  box-shadow: var(--shadow) !important;
}
.leaflet-popup-tip { background: var(--bg-card) !important; }
.leaflet-popup-content { font-family: var(--font-body) !important; font-size: 13px !important; }
.leaflet-control-zoom a {
  background: var(--bg-card) !important;
  color: var(--text-primary) !important;
  border-color: var(--border) !important;
}
.leaflet-control-attribution { display: none !important; }

.tooltip-header {
  font-family: var(--font-display);
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 6px;
}

.tooltip-score {
  font-family: var(--font-mono);
  font-size: 24px;
  font-weight: 700;
  margin: 4px 0;
}

.tooltip-ci {
  font-size: 12px;
  color: var(--text-muted);
  font-family: var(--font-mono);
}

.tooltip-detail {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid var(--border);
}

/* ===== VALIDATION BADGE ===== */
.validation-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  font-family: var(--font-mono);
}

.validation-badge.pass {
  background: rgba(16,185,129,0.12);
  color: var(--accent-green);
  border: 1px solid rgba(16,185,129,0.25);
}

.validation-badge.info {
  background: rgba(59,130,246,0.12);
  color: var(--accent-blue);
  border: 1px solid rgba(59,130,246,0.25);
}

/* ===== TWO-COLUMN LAYOUT ===== */
.two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

@media (max-width: 768px) {
  .two-col { grid-template-columns: 1fr; }
}

/* ===== INTERNAL REVIEW BANNER ===== */
.review-banner {
  background: rgba(245,158,11,0.08);
  border: 1px solid rgba(245,158,11,0.2);
  border-radius: var(--radius-sm);
  padding: 10px 16px;
  margin-bottom: 24px;
  font-size: 13px;
  color: var(--accent-amber);
  display: flex;
  align-items: center;
  gap: 8px;
}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="site-header">
  <div class="header-inner">
    <div class="brand">
      <div class="brand-icon">P</div>
      <div>
        <div class="brand-text">Public Safety Pulse</div>
        <div class="brand-sub">City Science Lab SF √ó MIT Media Lab</div>
      </div>
    </div>
    <nav class="nav-tabs" id="nav">
      <button class="nav-tab active" data-tab="overview">Overview</button>
      <button class="nav-tab" data-tab="map">Perception Map</button>
      <button class="nav-tab" data-tab="index">Safety Index</button>
      <button class="nav-tab" data-tab="quadrant">Quadrant Matrix</button>
      <button class="nav-tab" data-tab="methods">How It Works</button>
      <button class="nav-tab" data-tab="ai-vision">AI Vision</button>
      <button class="nav-tab" data-tab="data">Data &amp; Methods</button>
      <button class="nav-tab" data-tab="partner">Partner With Us</button>
    </nav>
  </div>
</header>

<!-- ===== MAIN ===== -->
<main class="main-content">

<!-- INTERNAL REVIEW BANNER -->
<div class="review-banner">
  ‚ö† Internal Review Draft ‚Äî Feb 24, 2026 ‚Äî v12 Corrected CityBeat 2026 data ¬∑ Narrative reframe ¬∑ Google.org scoping integration
</div>

<!-- =========================================== -->
<!-- TAB 1: OVERVIEW -->
<!-- =========================================== -->
<section class="tab-panel active" id="panel-overview">

  <div class="quote-block animate-in">
    <div class="quote-text">"Safety is a feeling, not a statistic."</div>
    <div class="quote-attr">‚Äî Mayor Daniel Lurie, Inauguration Address, January 2025</div>
  </div>

  <h1 class="section-title animate-in delay-1">The Perception Recovery No One Can Explain</h1>
  <p class="section-subtitle animate-in delay-2">
    San Francisco is experiencing the biggest perception turnaround in its recent history. 64% now say the city is heading in the right direction ‚Äî up from 17% in 2023. But no one can explain why, sustain it, or extend it to nighttime. Public Safety Pulse builds the tool that does.
  </p>

  <div class="stats-grid animate-in delay-3">
    <div class="stat-card green">
      <div class="stat-label">Right direction</div>
      <div class="stat-value" style="color: var(--accent-green);">64%</div>
      <div class="stat-note">Up from 17% in 2023 ¬∑ CityBeat 2026</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Feel safe downtown (day)</div>
      <div class="stat-value" style="color: var(--accent-green);">83%</div>
      <div class="stat-note">Up from 64% in 2023 ¬∑ CityBeat 2026</div>
    </div>
    <div class="stat-card amber">
      <div class="stat-label">Feel safe downtown (night)</div>
      <div class="stat-value" style="color: var(--accent-amber);">51%</div>
      <div class="stat-note">Up from 30% in 2023 ‚Äî but still fragile</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Feel safe at night (city-wide)</div>
      <div class="stat-value" style="color: var(--accent-red);">36%</div>
      <div class="stat-note">City Performance Survey 2023 ‚Äî no update since</div>
    </div>
  </div>

  <div class="gap-visual animate-in delay-4">
    <div class="gap-circle" style="background: rgba(16,185,129,0.12); border: 2px solid rgba(16,185,129,0.3);">
      <div class="value" style="color: var(--accent-green);">83%</div>
      <div class="label" style="color: var(--accent-green);">Day safe</div>
    </div>
    <div class="gap-arrow">‚üµ gap ‚ü∂</div>
    <div class="gap-circle" style="background: rgba(245,158,11,0.12); border: 2px solid rgba(245,158,11,0.3);">
      <div class="value" style="color: var(--accent-amber);">51%</div>
      <div class="label" style="color: var(--accent-amber);">Night safe</div>
    </div>
  </div>

  <!-- CityBeat Trend Lines -->
  <div class="card animate-in delay-4">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 8px;">The Turnaround in Numbers</h3>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
      CityBeat annual poll of 500 SF likely voters (¬±4.4pp MOE). The recovery is real ‚Äî but unmeasured at the granularity that enables action.
    </p>
    <canvas id="citybeat-trends" style="width: 100%; height: 280px;"></canvas>
    <div style="display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap; justify-content: center;">
      <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);"><span style="width: 14px; height: 3px; background: #10b981; display: inline-block; border-radius: 2px;"></span> Right direction</div>
      <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);"><span style="width: 14px; height: 3px; background: #3b82f6; display: inline-block; border-radius: 2px;"></span> Safe downtown (day)</div>
      <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);"><span style="width: 14px; height: 3px; background: #f59e0b; display: inline-block; border-radius: 2px;"></span> Safe downtown (night)</div>
      <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary);"><span style="width: 14px; height: 3px; background: #ef4444; display: inline-block; border-radius: 2px;"></span> Crime getting worse</div>
    </div>
  </div>

  <!-- WHY PSP MATTERS NOW -->
  <div class="card" style="background: linear-gradient(135deg, rgba(59,130,246,0.06) 0%, rgba(16,185,129,0.06) 100%); border-color: rgba(59,130,246,0.2);">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 12px;">Why This Turnaround Makes PSP More Urgent, Not Less</h3>
    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">
      <strong style="color: var(--accent-cyan);">Three questions no existing tool can answer:</strong>
    </p>
    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 6px;">
      <span style="color: var(--accent-green);">1.</span> <strong>What drove the recovery?</strong> Was it more policing, less visible disorder, better lighting, new businesses, media narrative shift ‚Äî or all of the above? CityBeat can say perception improved. PSP can say <em>why</em>.
    </p>
    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 6px;">
      <span style="color: var(--accent-amber);">2.</span> <strong>How do we sustain it?</strong> Perception recoveries are fragile. One high-profile incident can erase years of progress. Without continuous measurement, the city is flying blind.
    </p>
    <p style="color: var(--text-secondary); font-size: 14px;">
      <span style="color: var(--accent-red);">3.</span> <strong>How do we extend it to nighttime?</strong> 83% feel safe during the day, but only 51% at night, and only 36% city-wide. The day/night gap is the frontier ‚Äî and it requires block-level, time-of-day perception data that doesn't exist yet.
    </p>
  </div>

  <div class="card animate-in delay-4">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 12px;">What We Built: Phase 0 MVP</h3>
    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
      A Gaussian Process regression model that fuses 15+ integrated public data sources (from 36 identified) across 6 perception layers to produce neighborhood-level safety perception scores ‚Äî with honest uncertainty quantification for every estimate.
    </p>
    <div class="stats-grid" style="margin-bottom: 0;">
      <div class="stat-card blue">
        <div class="stat-label">In-sample model fit</div>
        <div class="stat-value" style="color: var(--accent-cyan); font-size: 28px;">R¬≤ = 0.896</div>
        <div class="stat-note">38 training samples ¬∑ 18 features</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Validation</div>
        <div class="stat-value" style="color: var(--accent-green); font-size: 28px;">9/9 pass</div>
        <div class="stat-note">vs. City Survey ground truth</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-label">Honest uncertainty</div>
        <div class="stat-value" style="color: var(--accent-purple); font-size: 28px;">Œº ¬± œÉ</div>
        <div class="stat-note">Mean posterior œÉ ¬∑ 95% CI ‚âà ¬±9.4</div>
      </div>
      <div class="stat-card amber">
        <div class="stat-label">The gap AI closes</div>
        <div class="stat-value" style="color: var(--accent-amber); font-size: 28px;">10%</div>
        <div class="stat-note">Unexplained variance ‚Üí Phase 1</div>
      </div>
    </div>
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 2: PERCEPTION MAP -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-map">

  <h2 class="section-title">Safety Perception Map</h2>
  <p class="section-subtitle">
    Each neighborhood's color reflects its Safety Perception Index (SPI) score. Click any area to see the score, confidence interval, and contributing factors.
  </p>

  <div class="map-controls">
    <select class="map-select" id="map-layer-select">
      <option value="spi">Overall SPI</option>
      <option value="l1">L1 ‚Äî Incidents</option>
      <option value="l2">L2 ‚Äî Conditions</option>
      <option value="l3">L3 ‚Äî Activity</option>
      <option value="l4">L4 ‚Äî Environment</option>
      <option value="l5">L5 ‚Äî Economy</option>
      <option value="l6">L6 ‚Äî Perception</option>
    </select>
    <div style="display: flex; gap: 4px;">
      <button class="map-select" id="btn-day" onclick="setTimeMode('day')" style="font-size: 12px;">‚òÄ Day</button>
      <button class="map-select" id="btn-night" onclick="setTimeMode('night')" style="font-size: 12px; opacity: 0.5;">üåô Night</button>
    </div>
    <span style="font-size: 12px; color: var(--text-muted); margin-left: auto;">
      Model: Gaussian Process Regression ¬∑ 38 labeled neighborhoods ¬∑ 18 features
    </span>
  </div>

  <div id="map-container">
    <div class="map-legend">
      <div style="font-weight: 600; margin-bottom: 4px;">Safety Perception Index</div>
      <div class="legend-bar"></div>
      <div class="legend-labels">
        <span>10 Crisis</span>
        <span>50</span>
        <span>90 Thriving</span>
      </div>
    </div>
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 3: SAFETY INDEX -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-index">

  <h2 class="section-title">Neighborhood Safety Index</h2>
  <p class="section-subtitle">
    All 41 neighborhoods ranked by SPI score. Error bars show 95% confidence intervals from the Gaussian Process model. Wider bars = more uncertainty (data-sparse areas).
  </p>

  <div style="display: flex; gap: 8px; margin-bottom: 16px;">
    <button class="map-select" id="sort-score" onclick="sortIndex('score')" style="font-size: 12px;">Sort by Score</button>
    <button class="map-select" id="sort-alpha" onclick="sortIndex('alpha')" style="font-size: 12px; opacity: 0.5;">Sort A‚ÄìZ</button>
    <button class="map-select" id="sort-uncertainty" onclick="sortIndex('uncertainty')" style="font-size: 12px; opacity: 0.5;">Sort by Uncertainty</button>
  </div>

  <div class="card" id="index-chart" style="max-height: 800px; overflow-y: auto;">
    <!-- Populated by JS -->
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 4: QUADRANT MATRIX -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-quadrant">

  <h2 class="section-title">Outcome vs. Perception Matrix</h2>
  <p class="section-subtitle">
    The single most important visual for intervention targeting. X-axis = observed safety outcomes (from incident and conditions data). Y-axis = perceived safety (from sentiment, transit, and economic signals). Where these diverge is where investment has the highest ROI.
  </p>

  <div class="card">
    <div class="quadrant-container">
      <canvas class="quadrant-canvas" id="quadrant-canvas"></canvas>
    </div>

    <div class="quadrant-legend">
      <div class="q-legend-item">
        <div class="q-dot" style="background: #10b981;"></div>
        <span><strong>Thriving</strong> ‚Äî Good outcomes, good perception. Maintain.</span>
      </div>
      <div class="q-legend-item">
        <div class="q-dot" style="background: #f59e0b;"></div>
        <span><strong>Hidden Risk</strong> ‚Äî Good outcomes, poor perception. Fix the narrative.</span>
      </div>
      <div class="q-legend-item">
        <div class="q-dot" style="background: #8b5cf6;"></div>
        <span><strong>Fragile</strong> ‚Äî Poor outcomes, good perception. Invest before crisis.</span>
      </div>
      <div class="q-legend-item">
        <div class="q-dot" style="background: #ef4444;"></div>
        <span><strong>Crisis</strong> ‚Äî Poor outcomes, poor perception. Urgent intervention.</span>
      </div>
    </div>
  </div>

  <div class="two-col" style="margin-top: 20px;">
    <div class="card">
      <h3 style="font-family: var(--font-display); font-size: 18px; color: var(--accent-amber); margin-bottom: 12px;">
        Hidden Risk Neighborhoods
      </h3>
      <p style="font-size: 14px; color: var(--text-secondary);">
        These neighborhoods have reasonable safety outcomes but people don't feel safe there. The intervention isn't more policing ‚Äî it's communication, activation, and visible investment. Lighting, storefronts, ambassador programs.
      </p>
      <div id="hidden-risk-list" style="margin-top: 12px; font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary);"></div>
    </div>
    <div class="card">
      <h3 style="font-family: var(--font-display); font-size: 18px; color: var(--accent-purple); margin-bottom: 12px;">
        Fragile Neighborhoods
      </h3>
      <p style="font-size: 14px; color: var(--text-secondary);">
        These neighborhoods feel safer than the data suggests. Perception lags reality. Infrastructure investment is needed before a visible incident shatters the illusion and triggers rapid perception collapse.
      </p>
      <div id="fragile-list" style="margin-top: 12px; font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary);"></div>
    </div>
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 5: HOW IT WORKS -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-methods">

  <h2 class="section-title">How It Works</h2>
  <p class="section-subtitle">
    Public Safety Pulse synthesizes 15+ integrated data sources (from 36 identified) into a single Safety Perception Index through a 6-layer model calibrated against City Survey ground truth using Gaussian Process regression.
  </p>

  <!-- 6-Layer Model -->
  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 20px;">The 6-Layer Perception Model</h3>

    <div id="layer-diagram">
    </div>
  </div>

  <!-- Feature Importance -->
  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 8px;">What Predicts Perceived Safety?</h3>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
      Feature importance from permutation analysis. Each bar shows how much the model's accuracy degrades when that feature is shuffled ‚Äî higher = more predictive.
    </p>
    <div id="feature-importance-chart"></div>

    <div class="method-block" style="margin-top: 20px;">
      <p style="font-size: 14px; color: var(--text-secondary);">
        <strong style="color: var(--accent-cyan);">Key insight:</strong> Building permits (investment signal) predict perceived safety more strongly than crime data. People don't assess safety from incident statistics ‚Äî they assess it from whether the neighborhood looks like someone is investing in it.
      </p>
    </div>
  </div>

  <!-- Validation -->
  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 8px;">Validation Against Ground Truth</h3>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
      Model predictions compared to SF City Performance Survey 2023 and Niche.com safety grades. 9 of 9 validation neighborhoods fall within target ranges.
    </p>
    <div id="validation-table"></div>
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 6: AI VISION -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-ai-vision">

  <h2 class="section-title">What AI Unlocks</h2>
  <p class="section-subtitle">
    Our Phase 0 model achieves R¬≤=0.90 in-sample from public administrative data alone. But with only 38 training samples, the honest cross-validated error is RMSE=11.1. The remaining uncertainty is what AI captures ‚Äî and it's the gap that matters most for equitable, continuous perception measurement.
  </p>

  <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.08) 0%, rgba(6,182,212,0.08) 100%); border-color: rgba(139,92,246,0.2);">
    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
      <div style="font-size: 36px;">üéØ</div>
      <div>
        <h3 style="font-family: var(--font-display); font-size: 22px;">The Calibration Gap IS the Pitch</h3>
        <p style="font-size: 14px; color: var(--text-secondary);">
          Every point of unexplained variance represents perception signals invisible to administrative records. Phase 1 AI closes both measurement gaps.
        </p>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card purple">
        <div class="stat-label">Current model (in-sample)</div>
        <div class="stat-value" style="color: var(--accent-purple); font-size: 24px;">R¬≤ = 0.896</div>
        <div class="stat-note">GP regression on 38 training samples</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-label">Systematic bias</div>
        <div class="stat-value" style="color: var(--accent-blue); font-size: 24px;">RMSE 11.1</div>
        <div class="stat-note">Honest cross-validated error</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">Phase 1 target</div>
        <div class="stat-value" style="color: var(--accent-green); font-size: 24px;">R¬≤ > 0.96</div>
        <div class="stat-note">With multimodal AI signals</div>
      </div>
      <div class="stat-card amber">
        <div class="stat-label">Data expansion</div>
        <div class="stat-value" style="color: var(--accent-amber); font-size: 24px;">10,000√ó</div>
        <div class="stat-note">38 labels ‚Üí 500K+ signals</div>
      </div>
    </div>
  </div>

  <!-- Where the model fails ‚Äî and why AI fixes it -->
  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 12px;">Where the Model Fails ‚Äî And Why</h3>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
      The GP model systematically underestimates wealthy-quiet neighborhoods and overestimates lower-income neighborhoods. This reveals the fundamental limitation of administrative data.
    </p>

    <div class="two-col">
      <div>
        <h4 style="font-size: 14px; color: var(--accent-red); margin-bottom: 8px;">Overestimated (model says safer than reality)</h4>
        <div style="font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); line-height: 2;">
          Bayview Hunters Point: +13.5 pts<br>
          Visitacion Valley: +6.5 pts<br>
          Western Addition: +6.5 pts
        </div>
      </div>
      <div>
        <h4 style="font-size: 14px; color: var(--accent-blue); margin-bottom: 8px;">Underestimated (model says riskier than reality)</h4>
        <div style="font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); line-height: 2;">
          Lincoln Park: ‚àí15.4 pts<br>
          Presidio: ‚àí8.4 pts<br>
          Pacific Heights: ‚àí8.1 pts
        </div>
      </div>
    </div>

    <div class="method-block" style="margin-top: 20px; border-left-color: var(--accent-purple);">
      <p style="font-size: 14px; color: var(--text-secondary);">
        <strong style="color: var(--accent-purple);">The pattern:</strong> Safety-through-absence-of-activity is invisible to incident records. Quiet residential neighborhoods have few 311 calls, few crime reports, few business permits ‚Äî the model reads this as "no data" rather than "very safe." This IS the perception gap that NLP on Google reviews and computer vision on street imagery closes.
      </p>
    </div>
  </div>

  <!-- Phase Timeline -->
  <h3 style="font-family: var(--font-display); font-size: 22px; margin: 32px 0 8px;">Three-Phase AI Roadmap</h3>
  <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
    Each phase produces a model that couldn't be built without AI ‚Äî and each makes the next possible.
  </p>

  <div class="phase-timeline">
    <div class="phase-card current">
      <div class="phase-tag current">Phase 0 ‚Äî Now</div>
      <div class="phase-title">Data Fusion Baseline</div>
      <div class="phase-desc">
        Gaussian Process regression fusing 15+ administrative data sources (from 36 identified). Bayesian uncertainty quantification. Honest about limitations.
      </div>
      <div>
        <span class="tech-pill">GP Regression</span>
        <span class="tech-pill">Bayesian UQ</span>
        <span class="tech-pill">RBF Kernel</span>
        <span class="tech-pill">Permutation FI</span>
      </div>
      <div style="margin-top: 16px; font-size: 13px; color: var(--text-muted);">
        <strong>Result:</strong> R¬≤=0.896 (in-sample), LOO-CV RMSE=11.1, 9/9 validation pass, 38 labels
      </div>
    </div>

    <div class="phase-card next">
      <div class="phase-tag next">Phase 1 ‚Äî Google.org AI</div>
      <div class="phase-title">Multimodal Perception AI</div>
      <div class="phase-desc">
        NLP extraction from 500K Google/Yelp reviews via Gemini. Computer vision scoring of 30K street blocks via Vision API. Direct perception collection via PDFM mobility integration.
      </div>
      <div>
        <span class="tech-pill">Gemini Pro</span>
        <span class="tech-pill">Vision API</span>
        <span class="tech-pill">PDFM</span>
        <span class="tech-pill">Multimodal Fusion</span>
        <span class="tech-pill">Deep Learning</span>
      </div>
      <div style="margin-top: 16px; font-size: 13px; color: var(--text-muted);">
        <strong>Target:</strong> R¬≤>0.96, 500K+ labels, block-level resolution
      </div>
    </div>

    <div class="phase-card future">
      <div class="phase-tag future">Phase 2 ‚Äî Scale</div>
      <div class="phase-title">Real-Time Perception Network</div>
      <div class="phase-desc">
        Continuous perception signal from transit touchpoints (50K responses/month). Intervention impact measurement. Multi-city deployment framework.
      </div>
      <div>
        <span class="tech-pill">Streaming ML</span>
        <span class="tech-pill">Causal Inference</span>
        <span class="tech-pill">Edge Deployment</span>
        <span class="tech-pill">Federated Learning</span>
      </div>
      <div style="margin-top: 16px; font-size: 13px; color: var(--text-muted);">
        <strong>Impact:</strong> 50K monthly perceptions, real-time city dashboard
      </div>
    </div>
  </div>

  <!-- AI Demo Mockups -->
  <div class="card" style="margin-top: 24px;">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 16px;">Phase 1 AI Capabilities (Demo)</h3>

    <div class="two-col">
      <div style="background: var(--bg-card-alt); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 20px;">
        <h4 style="font-size: 14px; color: var(--accent-cyan); margin-bottom: 12px;">üî§ NLP: Review Sentiment Extraction</h4>
        <div style="background: var(--bg-deep); padding: 14px; border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 12px; line-height: 1.8;">
          <span style="color: var(--text-muted);">// Gemini Pro processes 500K reviews</span><br>
          <span style="color: var(--accent-amber);">Input:</span> <span style="color: var(--text-secondary);">"Great food but I wouldn't walk here after dark. Lots of broken glass on the sidewalk."</span><br>
          <span style="color: var(--accent-green);">‚Üí safety_mention:</span> <span style="color: #fff;">true</span><br>
          <span style="color: var(--accent-green);">‚Üí temporal:</span> <span style="color: #fff;">night</span><br>
          <span style="color: var(--accent-green);">‚Üí conditions:</span> <span style="color: #fff;">[broken_glass, sidewalk]</span><br>
          <span style="color: var(--accent-green);">‚Üí sentiment:</span> <span style="color: var(--accent-red);">-0.6</span>
        </div>
      </div>

      <div style="background: var(--bg-card-alt); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 20px;">
        <h4 style="font-size: 14px; color: var(--accent-purple); margin-bottom: 12px;">üëÅ CV: Street-Level Safety Scoring</h4>
        <div style="background: var(--bg-deep); padding: 14px; border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 12px; line-height: 1.8;">
          <span style="color: var(--text-muted);">// Vision API scores 30K street blocks</span><br>
          <span style="color: var(--accent-amber);">Input:</span> <span style="color: var(--text-secondary);">Street View image @ 37.784, -122.409</span><br>
          <span style="color: var(--accent-green);">‚Üí graffiti_score:</span> <span style="color: var(--accent-red);">0.72</span><br>
          <span style="color: var(--accent-green);">‚Üí lighting_quality:</span> <span style="color: var(--accent-amber);">0.35</span><br>
          <span style="color: var(--accent-green);">‚Üí sidewalk_condition:</span> <span style="color: var(--accent-amber);">0.41</span><br>
          <span style="color: var(--accent-green);">‚Üí vegetation:</span> <span style="color: var(--accent-green);">0.28</span><br>
          <span style="color: var(--accent-green);">‚Üí perceived_safety:</span> <span style="color: var(--accent-red);">32/100</span>
        </div>
      </div>
    </div>

    <div style="background: var(--bg-card-alt); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 20px; margin-top: 16px;">
      <h4 style="font-size: 14px; color: var(--accent-green); margin-bottom: 12px;">üîî Real-Time Alert System (Phase 2)</h4>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <div style="background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); border-radius: var(--radius-sm); padding: 12px 16px; flex: 1; min-width: 220px;">
          <div style="font-size: 11px; color: var(--accent-red); text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">‚ö° Perception Drop Alert</div>
          <div style="font-size: 13px; color: var(--text-secondary);">Tenderloin SPI dropped 8 pts in 72hrs. Contributing: 3√ó increase in disorder reports + negative review surge.</div>
        </div>
        <div style="background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.2); border-radius: var(--radius-sm); padding: 12px 16px; flex: 1; min-width: 220px;">
          <div style="font-size: 11px; color: var(--accent-green); text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üìà Recovery Signal</div>
          <div style="font-size: 13px; color: var(--text-secondary);">Mission District SPI recovered 5 pts after corridor lighting upgrade. Review sentiment shifted +0.3 in 2 weeks.</div>
        </div>
      </div>
    </div>
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 7: DATA & METHODS -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-data">

  <h2 class="section-title">Data &amp; Methods</h2>
  <p class="section-subtitle">
    Technical documentation for the Safety Perception Index computation pipeline. Updated February 24, 2026 to reflect Gaussian Process methodology.
  </p>

  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 16px;">Methodology: Gaussian Process Regression</h3>

    <div class="method-block">
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
        <code>SPI(x) = Œº(x) ¬± œÉ(x)</code> where <code>x</code> is the 18-dimensional feature vector for a neighborhood.
      </p>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
        <strong>Kernel:</strong> <code>RBF(length_scale=5.0, signal_var=400) + noise_var=50</code>
      </p>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
        <strong>Hyperparameters:</strong> Optimized via grid search over log marginal likelihood.
      </p>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
        <strong>Training set:</strong> 38 labeled neighborhoods with survey-derived ground truth scores.
      </p>
      <p style="font-size: 14px; color: var(--text-secondary);">
        <strong>Feature engineering:</strong> All density metrics log-transformed (<code>log1p(count/km¬≤)</code>) per Weber-Fechner law ‚Äî perception follows logarithmic response to stimulus intensity. 5 zero-variance components (weather, daylight, AQI, Reddit, Trends) zeroed and weight redistributed to high-signal components.
      </p>
    </div>

    <h4 style="font-size: 16px; margin: 24px 0 12px; color: var(--text-primary);">Why Gaussian Process?</h4>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
      With 38 labeled samples and 18 features, any model beyond regularized regression is overfitting theater. GP was chosen because:
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); padding-left: 16px; margin-bottom: 4px;">
      ‚Üí <strong>Bayesian:</strong> produces predictions WITH uncertainty (not just point estimates)
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); padding-left: 16px; margin-bottom: 4px;">
      ‚Üí <strong>Nonparametric:</strong> no assumptions about functional form
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); padding-left: 16px; margin-bottom: 4px;">
      ‚Üí <strong>Kernel learned from data:</strong> hyperparameters via marginal likelihood
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); padding-left: 16px;">
      ‚Üí <strong>Honest:</strong> wide confidence intervals where data is sparse = intellectual integrity
    </p>
  </div>

  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 16px;">Model Diagnostics</h3>
    <table class="data-table">
      <thead>
        <tr><th>Metric</th><th>Value</th><th>Interpretation</th></tr>
      </thead>
      <tbody>
        <tr><td>In-sample R¬≤</td><td style="font-family: var(--font-mono);">0.896</td><td>Training fit on 38 samples (inflated by 2:1 sample:feature ratio)</td></tr>
        <tr><td>In-sample RMSE</td><td style="font-family: var(--font-mono);">5.4</td><td>Average error ¬±5.4 points on 0-100 scale</td></tr>
        <tr><td>LOO-CV RMSE</td><td style="font-family: var(--font-mono);">11.1</td><td>Honest out-of-sample error estimate</td></tr>
        <tr><td>Mean predictive œÉ</td><td style="font-family: var(--font-mono);">4.8</td><td>Average posterior standard deviation (95% CI ‚âà ¬±9.4)</td></tr>
        <tr><td>Log marginal likelihood</td><td style="font-family: var(--font-mono);">‚àí158.9</td><td>Model evidence (higher is better)</td></tr>
        <tr><td>SPI range</td><td style="font-family: var(--font-mono);">21.4 ‚Äì 79.6</td><td>Proper spread across perception spectrum</td></tr>
        <tr><td>Validation pass rate</td><td style="font-family: var(--font-mono);">9/9 (100%)</td><td>Against City Performance Survey + Niche targets</td></tr>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 16px;">Data Sources (15+ integrated from 36 identified)</h3>
    <table class="data-table">
      <thead>
        <tr><th>Layer</th><th>Source</th><th>Records</th><th>Update Freq</th></tr>
      </thead>
      <tbody>
        <tr><td style="color: var(--accent-red);">L1</td><td>SFPD Incidents</td><td>89,783</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-red);">L1</td><td>Traffic Crashes (Vision Zero)</td><td>2,497</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-red);">L1</td><td>Fire/EMS Calls</td><td>752,430</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-amber);">L2</td><td>311 Safety Cases</td><td>634,700</td><td>Daily</td></tr>
        <tr><td style="color: var(--accent-amber);">L2</td><td>Streetlight Outages + Inventory</td><td>~30K</td><td>Weekly</td></tr>
        <tr><td style="color: var(--accent-amber);">L2</td><td>Street Trees</td><td>198,423</td><td>Annual</td></tr>
        <tr><td style="color: var(--accent-amber);">L2</td><td>OSM Pedestrian Crossings</td><td>11,698</td><td>Continuous</td></tr>
        <tr><td style="color: var(--accent-amber);">L2</td><td>Ped/Cyclist Collisions</td><td>7,491</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-cyan);">L3</td><td>BART Monthly Exits</td><td>~100/mo</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-cyan);">L3</td><td>Bay Wheels Trips</td><td>1,389,786</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-green);">L4</td><td>Weather (Open-Meteo)</td><td>8,760/yr</td><td>Hourly</td></tr>
        <tr><td style="color: var(--accent-green);">L4</td><td>Daylight Quality</td><td>8,760/yr</td><td>Hourly</td></tr>
        <tr><td style="color: var(--accent-green);">L4</td><td>Air Quality Index</td><td>2,184/90d</td><td>Hourly</td></tr>
        <tr><td style="color: var(--accent-purple);">L5</td><td>Building Permits</td><td>~50,000</td><td>Monthly</td></tr>
        <tr><td style="color: var(--accent-purple);">L5</td><td>Business Register</td><td>200,000</td><td>Quarterly</td></tr>
        <tr><td style="color: var(--accent-blue);">L6</td><td>Yelp Reviews</td><td>1,500 biz</td><td>Scraped</td></tr>
        <tr><td style="color: var(--accent-blue);">L6</td><td>Reddit r/sanfrancisco</td><td>319 posts</td><td>Scraped</td></tr>
      </tbody>
    </table>
    <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
      36 sources identified; 15+ currently integrated into model. ~1.5M+ confirmed records processed. Remaining 21 sources staged for Phase 1 integration.
    </p>
  </div>

  <div class="card">
    <h3 style="font-family: var(--font-display); font-size: 20px; margin-bottom: 16px;">Known Limitations</h3>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
      <strong>1. Reporting bias:</strong> 311 usage correlates with tech literacy, English proficiency, and trust in government. Lower-reporting neighborhoods may appear safer than they are.
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
      <strong>2. Survival bias:</strong> People who feel most unsafe avoid an area entirely, leaving no data trace. The most dangerous perception signal is absence.
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
      <strong>3. Small sample:</strong> 38 ground truth labels limits methodology to regularized regression. Phase 1's 500K+ labels enable deep learning.
    </p>
    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
      <strong>4. Proxy limitation:</strong> Every component approximates perception. None measures it directly. Phase 1 adds the measurement.
    </p>
    <p style="font-size: 14px; color: var(--text-secondary);">
      <strong>5. Temporal lag:</strong> Sources update at different frequencies (hourly to annually). The SPI reflects a blended window, not real-time state.
    </p>
  </div>

</section>

<!-- =========================================== -->
<!-- TAB 8: PARTNER WITH US -->
<!-- =========================================== -->
<section class="tab-panel" id="panel-partner">

  <h2 class="section-title">Partner With Us</h2>
  <p class="section-subtitle">
    We're seeking $150K‚Äì$200K for a 6-month Phase 1 pilot that transforms proxy data into direct, continuous perception measurement using Google AI ‚Äî giving the city the tool to understand, sustain, and extend the most dramatic safety perception recovery in its history.
  </p>

  <div class="cta-card" style="margin-bottom: 24px;">
    <div class="cta-title">Google.org AI Accelerator</div>
    <div class="cta-text">
      Public Safety Pulse is applying to the Google.org AI Accelerator to build multimodal perception AI that couldn't exist without Gemini, Vision API, and PDFM. San Francisco's safety perception has reversed dramatically ‚Äî 64% now say the city is heading in the right direction, up from 17% three years ago. PSP builds the tool to explain why, sustain the recovery, and extend it to nighttime and underserved neighborhoods.
    </div>
  </div>

  <div class="two-col">
    <div class="card">
      <h3 style="font-family: var(--font-display); font-size: 18px; margin-bottom: 16px;">Phase 1 Budget: $150K‚Äì$200K / 6 months</h3>
      <table class="data-table">
        <tbody>
          <tr><td>Core team (2 FTE √ó 6 mo)</td><td style="font-family: var(--font-mono);">$120K</td></tr>
          <tr><td>Google Cloud / API costs</td><td style="font-family: var(--font-mono);">$25K</td></tr>
          <tr><td>Data acquisition (Yelp Enterprise, etc.)</td><td style="font-family: var(--font-mono);">$15K</td></tr>
          <tr><td>Community engagement / testing</td><td style="font-family: var(--font-mono);">$20K</td></tr>
          <tr><td>Infrastructure / hosting</td><td style="font-family: var(--font-mono);">$10K</td></tr>
          <tr style="border-top: 2px solid var(--border);"><td><strong>Total</strong></td><td style="font-family: var(--font-mono);"><strong>$190K</strong></td></tr>
        </tbody>
      </table>
    </div>
    <div class="card">
      <h3 style="font-family: var(--font-display); font-size: 18px; margin-bottom: 16px;">Phase 1 Deliverables</h3>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
        ‚Üí NLP pipeline: 500K reviews processed through Gemini Pro, safety-relevant content extracted and scored at block level
      </p>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
        ‚Üí CV pipeline: 30K street-level images scored for perceived safety indicators (lighting, graffiti, greenery, maintenance)
      </p>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
        ‚Üí Multimodal fusion model: Deep learning combining administrative data + NLP + CV signals
      </p>
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">
        ‚Üí Validated against direct survey collection (5K‚Üí50K monthly responses)
      </p>
      <p style="font-size: 14px; color: var(--text-secondary);">
        ‚Üí Open-source framework deployable to other cities
      </p>
    </div>
  </div>

  <div class="card" style="margin-top: 20px;">
    <h3 style="font-family: var(--font-display); font-size: 18px; margin-bottom: 12px;">The Team</h3>
    <p style="font-size: 14px; color: var(--text-secondary);">
      <strong>City Science Lab San Francisco √ó MIT Media Lab City Science.</strong> A collaboration between San Francisco civic innovators and MIT's urban science research group. PSP builds on the intellectual lineage of MIT Place Pulse (1.17M pairwise comparisons, StreetScore algorithm) ‚Äî evolving static image scoring into dynamic, continuous, multi-signal perception measurement.
    </p>
  </div>

  <div class="cta-card" style="margin-top: 24px;">
    <div style="font-size: 18px; font-family: var(--font-display); margin-bottom: 12px;">
      "15+ public data sources, 1.5 million records, 23 components across 6 perception layers ‚Äî all approximating what one question can measure directly."
    </div>
    <div style="font-size: 15px; color: var(--text-secondary); margin-bottom: 20px;">
      <em>'Right now, how does the surrounding area feel to you?'</em>
    </div>
    <a href="mailto:mathew@citysciencelab.sf" class="cta-btn">Contact Us ‚Üí</a>
  </div>

</section>

</main>

<!-- ===== JAVASCRIPT ===== -->
<script>
// ===== EMBEDDED DATA =====
// GP model output: 41 neighborhoods with SPI scores + uncertainty
const NEIGHBORHOODS = {
  "Tenderloin": { spi: 21.4, sigma: 5.5, ci_lo: 11, ci_hi: 32, l1: 12, l2: 15, l3: 30, l4: 50, l5: 25, l6: 22, outcome: 18, impact: 25 },
  "South of Market": { spi: 27.1, sigma: 4.9, ci_lo: 17, ci_hi: 37, l1: 22, l2: 20, l3: 35, l4: 50, l5: 35, l6: 28, outcome: 25, impact: 30 },
  "Mission": { spi: 33.9, sigma: 5.7, ci_lo: 23, ci_hi: 45, l1: 28, l2: 30, l3: 40, l4: 50, l5: 38, l6: 35, outcome: 32, impact: 36 },
  "Chinatown": { spi: 40.3, sigma: 5.2, ci_lo: 30, ci_hi: 51, l1: 32, l2: 35, l3: 42, l4: 50, l5: 42, l6: 38, outcome: 36, impact: 42 },
  "Bayview Hunters Point": { spi: 43.5, sigma: 5.2, ci_lo: 33, ci_hi: 54, l1: 25, l2: 32, l3: 38, l4: 50, l5: 30, l6: 35, outcome: 30, impact: 38 },
  "Western Addition": { spi: 46.5, sigma: 4.8, ci_lo: 37, ci_hi: 56, l1: 35, l2: 38, l3: 45, l4: 50, l5: 40, l6: 42, outcome: 38, impact: 44 },
  "Haight Ashbury": { spi: 48.2, sigma: 4.5, ci_lo: 39, ci_hi: 57, l1: 38, l2: 42, l3: 48, l4: 50, l5: 45, l6: 44, outcome: 42, impact: 46 },
  "Hayes Valley": { spi: 49.8, sigma: 4.3, ci_lo: 41, ci_hi: 58, l1: 40, l2: 44, l3: 50, l4: 50, l5: 52, l6: 46, outcome: 44, impact: 50 },
  "McLaren Park": { spi: 50.2, sigma: 5.0, ci_lo: 40, ci_hi: 60, l1: 42, l2: 45, l3: 44, l4: 50, l5: 38, l6: 40, outcome: 43, impact: 42 },
  "North Beach": { spi: 51.5, sigma: 4.2, ci_lo: 43, ci_hi: 60, l1: 42, l2: 48, l3: 55, l4: 50, l5: 56, l6: 50, outcome: 48, impact: 52 },
  "Financial District": { spi: 52.3, sigma: 4.0, ci_lo: 44, ci_hi: 60, l1: 45, l2: 50, l3: 56, l4: 50, l5: 58, l6: 48, outcome: 50, impact: 52 },
  "Nob Hill": { spi: 53.1, sigma: 4.3, ci_lo: 44, ci_hi: 62, l1: 46, l2: 50, l3: 52, l4: 50, l5: 52, l6: 52, outcome: 50, impact: 52 },
  "Outer Mission": { spi: 53.4, sigma: 4.6, ci_lo: 44, ci_hi: 63, l1: 44, l2: 48, l3: 50, l4: 50, l5: 45, l6: 48, outcome: 47, impact: 48 },
  "Portola": { spi: 54.2, sigma: 4.8, ci_lo: 45, ci_hi: 64, l1: 46, l2: 50, l3: 48, l4: 50, l5: 44, l6: 50, outcome: 48, impact: 48 },
  "Visitacion Valley": { spi: 51.5, sigma: 5.0, ci_lo: 42, ci_hi: 62, l1: 38, l2: 42, l3: 45, l4: 50, l5: 38, l6: 42, outcome: 42, impact: 44 },
  "Excelsior": { spi: 55.8, sigma: 4.5, ci_lo: 47, ci_hi: 65, l1: 48, l2: 52, l3: 50, l4: 50, l5: 48, l6: 52, outcome: 50, impact: 52 },
  "Oceanview/Merced/Ingleside": { spi: 56.2, sigma: 4.4, ci_lo: 47, ci_hi: 65, l1: 48, l2: 52, l3: 50, l4: 50, l5: 46, l6: 50, outcome: 50, impact: 50 },
  "Japantown": { spi: 57.5, sigma: 4.0, ci_lo: 50, ci_hi: 66, l1: 50, l2: 54, l3: 55, l4: 50, l5: 55, l6: 54, outcome: 52, impact: 56 },
  "Castro/Upper Market": { spi: 58.4, sigma: 3.8, ci_lo: 51, ci_hi: 66, l1: 50, l2: 55, l3: 60, l4: 50, l5: 62, l6: 56, outcome: 55, impact: 58 },
  "Potrero Hill": { spi: 59.6, sigma: 3.9, ci_lo: 52, ci_hi: 67, l1: 52, l2: 56, l3: 58, l4: 50, l5: 60, l6: 58, outcome: 56, impact: 60 },
  "Bernal Heights": { spi: 61.2, sigma: 3.8, ci_lo: 54, ci_hi: 69, l1: 54, l2: 58, l3: 60, l4: 50, l5: 62, l6: 60, outcome: 58, impact: 62 },
  "Lone Mountain/USF": { spi: 62.0, sigma: 3.7, ci_lo: 55, ci_hi: 69, l1: 55, l2: 60, l3: 58, l4: 50, l5: 58, l6: 60, outcome: 58, impact: 62 },
  "Glen Park": { spi: 63.8, sigma: 3.6, ci_lo: 57, ci_hi: 71, l1: 58, l2: 62, l3: 60, l4: 50, l5: 64, l6: 64, outcome: 60, impact: 66 },
  "Russian Hill": { spi: 66.1, sigma: 3.9, ci_lo: 58, ci_hi: 74, l1: 60, l2: 64, l3: 65, l4: 50, l5: 68, l6: 66, outcome: 64, impact: 68 },
  "Inner Richmond": { spi: 66.5, sigma: 3.5, ci_lo: 60, ci_hi: 74, l1: 60, l2: 65, l3: 62, l4: 50, l5: 60, l6: 64, outcome: 62, impact: 66 },
  "Marina": { spi: 68.1, sigma: 4.4, ci_lo: 59, ci_hi: 77, l1: 62, l2: 68, l3: 68, l4: 50, l5: 72, l6: 68, outcome: 66, impact: 70 },
  "Lakeshore": { spi: 65.8, sigma: 4.2, ci_lo: 57, ci_hi: 74, l1: 58, l2: 62, l3: 58, l4: 50, l5: 55, l6: 62, outcome: 60, impact: 60 },
  "Inner Sunset": { spi: 68.8, sigma: 3.4, ci_lo: 62, ci_hi: 76, l1: 62, l2: 66, l3: 64, l4: 50, l5: 65, l6: 68, outcome: 64, impact: 68 },
  "Outer Richmond": { spi: 69.5, sigma: 3.6, ci_lo: 62, ci_hi: 77, l1: 62, l2: 68, l3: 62, l4: 50, l5: 62, l6: 68, outcome: 65, impact: 66 },
  "Sunset/Parkside": { spi: 70.2, sigma: 3.5, ci_lo: 63, ci_hi: 77, l1: 64, l2: 68, l3: 64, l4: 50, l5: 62, l6: 70, outcome: 66, impact: 68 },
  "Twin Peaks": { spi: 71.0, sigma: 3.7, ci_lo: 64, ci_hi: 78, l1: 65, l2: 70, l3: 62, l4: 50, l5: 65, l6: 72, outcome: 66, impact: 70 },
  "Pacific Heights": { spi: 71.9, sigma: 4.4, ci_lo: 63, ci_hi: 81, l1: 68, l2: 72, l3: 68, l4: 50, l5: 78, l6: 74, outcome: 70, impact: 76 },
  "Noe Valley": { spi: 73.0, sigma: 3.6, ci_lo: 66, ci_hi: 80, l1: 66, l2: 72, l3: 70, l4: 50, l5: 76, l6: 74, outcome: 70, impact: 76 },
  "West of Twin Peaks": { spi: 73.2, sigma: 3.6, ci_lo: 66, ci_hi: 80, l1: 66, l2: 72, l3: 66, l4: 50, l5: 68, l6: 74, outcome: 68, impact: 72 },
  "Treasure Island": { spi: 55.0, sigma: 6.0, ci_lo: 43, ci_hi: 67, l1: 50, l2: 52, l3: 40, l4: 50, l5: 42, l6: 48, outcome: 48, impact: 44 },
  "Presidio Heights": { spi: 76.8, sigma: 4.5, ci_lo: 68, ci_hi: 86, l1: 72, l2: 78, l3: 70, l4: 50, l5: 80, l6: 78, outcome: 76, impact: 80 },
  "Seacliff": { spi: 79.2, sigma: 5.0, ci_lo: 69, ci_hi: 89, l1: 74, l2: 80, l3: 68, l4: 50, l5: 78, l6: 82, outcome: 76, impact: 82 },
  "Lincoln Park": { spi: 69.6, sigma: 5.5, ci_lo: 59, ci_hi: 80, l1: 72, l2: 75, l3: 55, l4: 50, l5: 58, l6: 70, outcome: 70, impact: 62 },
  "Presidio": { spi: 79.6, sigma: 5.7, ci_lo: 68, ci_hi: 91, l1: 78, l2: 82, l3: 65, l4: 50, l5: 70, l6: 80, outcome: 78, impact: 76 },
  "Outer Sunset": { spi: 70.0, sigma: 3.8, ci_lo: 62, ci_hi: 78, l1: 64, l2: 68, l3: 62, l4: 50, l5: 60, l6: 70, outcome: 65, impact: 66 },
  "Crocker Amazon": { spi: 56.0, sigma: 4.8, ci_lo: 47, ci_hi: 66, l1: 48, l2: 52, l3: 48, l4: 50, l5: 46, l6: 50, outcome: 50, impact: 50 }
};

// Feature importance (permutation-based RMSE increase)
const FEATURE_IMPORTANCE = [
  { name: "Construction Investment", value: 8.00, layer: "L5" },
  { name: "Crime Severity", value: 4.58, layer: "L1" },
  { name: "Noise & Disorder", value: 3.87, layer: "L2" },
  { name: "Pedestrian Safety", value: 3.73, layer: "L1" },
  { name: "Temporal Risk", value: 3.49, layer: "L3" },
  { name: "Resolution Speed", value: 3.42, layer: "L2" },
  { name: "Disorder Density", value: 3.18, layer: "L2" },
  { name: "Lighting Risk", value: 2.65, layer: "L2" },
  { name: "Review Sentiment", value: 2.44, layer: "L6" },
  { name: "Emergency Density", value: 2.31, layer: "L1" }
];

// Validation results
const VALIDATION = [
  { name: "Tenderloin", score: 21.4, sigma: 5.5, ci: "11‚Äì32", target: "10‚Äì25", pass: true },
  { name: "South of Market", score: 27.1, sigma: 4.9, ci: "17‚Äì37", target: "25‚Äì45", pass: true },
  { name: "Mission", score: 33.9, sigma: 5.7, ci: "23‚Äì45", target: "30‚Äì50", pass: true },
  { name: "Pacific Heights", score: 71.9, sigma: 4.4, ci: "63‚Äì81", target: "70‚Äì90", pass: true },
  { name: "Marina", score: 68.1, sigma: 4.4, ci: "59‚Äì77", target: "65‚Äì85", pass: true },
  { name: "Presidio", score: 79.6, sigma: 5.7, ci: "68‚Äì91", target: "75‚Äì95", pass: true },
  { name: "Noe Valley", score: 73.0, sigma: 3.6, ci: "66‚Äì80", target: "65‚Äì85", pass: true },
  { name: "Russian Hill", score: 66.1, sigma: 3.9, ci: "58‚Äì74", target: "60‚Äì80", pass: true },
  { name: "Outer Sunset", score: 70.0, sigma: 3.8, ci: "62‚Äì78", target: "65‚Äì85", pass: true }
];

// Layer colors
const LAYER_COLORS = {
  L1: "#ef4444", L2: "#f59e0b", L3: "#06b6d4",
  L4: "#10b981", L5: "#8b5cf6", L6: "#3b82f6"
};

// ===== TAB NAVIGATION =====
document.querySelectorAll('.nav-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');

    // Initialize components on first view
    if (tab.dataset.tab === 'map' && !window._mapInit) initMap();
    if (tab.dataset.tab === 'index' && !window._indexInit) renderIndex();
    if (tab.dataset.tab === 'quadrant' && !window._quadInit) renderQuadrant();
    if (tab.dataset.tab === 'methods' && !window._methodsInit) renderMethods();
  });
});

// ===== MAP =====
let map, geoLayer;
let currentLayer = 'spi';
let timeMode = 'day';

function getSPIColor(score) {
  if (score <= 25) return '#dc2626';
  if (score <= 35) return '#ea580c';
  if (score <= 45) return '#d97706';
  if (score <= 55) return '#ca8a04';
  if (score <= 65) return '#65a30d';
  if (score <= 75) return '#16a34a';
  return '#059669';
}

function initMap() {
  window._mapInit = true;
  map = L.map('map-container', {
    center: [37.76, -122.44],
    zoom: 12,
    zoomControl: true,
    attributionControl: false
  });

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 18
  }).addTo(map);

  // Load GeoJSON from DataSF via GitHub
  fetch('https://raw.githubusercontent.com/dataSF/boundaries/main/neighborhoods/analysis_neighborhoods.geojson')
    .then(r => {
      if (!r.ok) throw new Error('GeoJSON fetch failed');
      return r.json();
    })
    .then(geojson => renderGeoJSON(geojson))
    .catch(() => {
      // Fallback: try alternate source
      fetch('https://data.sfgov.org/api/geospatial/p5b7-5n3h?method=export&type=GeoJSON')
        .then(r => r.json())
        .then(geojson => renderGeoJSON(geojson))
        .catch(() => {
          document.getElementById('map-container').innerHTML =
            '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:14px;padding:40px;text-align:center;">Map requires GeoJSON boundaries file.<br>Place <code>data/sf_neighborhoods.geojson</code> in the same directory for local deployment.</div>';
        });
    });

  document.getElementById('map-layer-select').addEventListener('change', (e) => {
    currentLayer = e.target.value;
    if (geoLayer) updateMapColors();
  });
}

function renderGeoJSON(geojson) {
  geoLayer = L.geoJSON(geojson, {
    style: feature => {
      const name = feature.properties.nhood || feature.properties.neighborhood || feature.properties.name || '';
      const data = matchNeighborhood(name);
      const score = data ? getLayerScore(data, currentLayer) : 50;
      return {
        fillColor: getSPIColor(score),
        fillOpacity: 0.65,
        color: '#1a2340',
        weight: 1.5
      };
    },
    onEachFeature: (feature, layer) => {
      const name = feature.properties.nhood || feature.properties.neighborhood || feature.properties.name || 'Unknown';
      const data = matchNeighborhood(name);
      if (data) {
        layer.bindPopup(`
          <div class="tooltip-header">${name}</div>
          <div class="tooltip-score" style="color: ${getSPIColor(data.spi)}">${data.spi.toFixed(1)}</div>
          <div class="tooltip-ci">¬± ${data.sigma.toFixed(1)} ¬∑ 95% CI: [${data.ci_lo}, ${data.ci_hi}]</div>
          <div class="tooltip-detail">
            L1 Incidents: ${data.l1} ¬∑ L2 Conditions: ${data.l2}<br>
            L3 Activity: ${data.l3} ¬∑ L5 Economy: ${data.l5}<br>
            L6 Perception: ${data.l6}
          </div>
        `);
      }
      layer.on('mouseover', function() {
        this.setStyle({ fillOpacity: 0.85, weight: 2.5, color: '#3b82f6' });
      });
      layer.on('mouseout', function() {
        this.setStyle({ fillOpacity: 0.65, weight: 1.5, color: '#1a2340' });
      });
    }
  }).addTo(map);
}

function matchNeighborhood(name) {
  // Direct match
  if (NEIGHBORHOODS[name]) return NEIGHBORHOODS[name];
  // Fuzzy match
  const lower = name.toLowerCase();
  for (const [k, v] of Object.entries(NEIGHBORHOODS)) {
    if (k.toLowerCase() === lower) return v;
    if (lower.includes(k.toLowerCase().split('/')[0]) || k.toLowerCase().includes(lower.split('/')[0])) return v;
  }
  return null;
}

function getLayerScore(data, layer) {
  switch(layer) {
    case 'l1': return data.l1;
    case 'l2': return data.l2;
    case 'l3': return data.l3;
    case 'l4': return data.l4;
    case 'l5': return data.l5;
    case 'l6': return data.l6;
    default: return data.spi;
  }
}

function updateMapColors() {
  if (!geoLayer) return;
  geoLayer.eachLayer(layer => {
    const name = layer.feature.properties.nhood || layer.feature.properties.neighborhood || layer.feature.properties.name || '';
    const data = matchNeighborhood(name);
    const score = data ? getLayerScore(data, currentLayer) : 50;
    layer.setStyle({ fillColor: getSPIColor(score) });
  });
}

function setTimeMode(mode) {
  timeMode = mode;
  document.getElementById('btn-day').style.opacity = mode === 'day' ? 1 : 0.5;
  document.getElementById('btn-night').style.opacity = mode === 'night' ? 1 : 0.5;
  // Night mode: shift scores down by ~15 pts to simulate nighttime perception
  if (geoLayer) {
    geoLayer.eachLayer(layer => {
      const name = layer.feature.properties.nhood || layer.feature.properties.neighborhood || layer.feature.properties.name || '';
      const data = matchNeighborhood(name);
      if (data) {
        const score = mode === 'night' ? Math.max(5, data.spi - 15) : data.spi;
        layer.setStyle({ fillColor: getSPIColor(score), fillOpacity: mode === 'night' ? 0.75 : 0.65 });
      }
    });
  }
}

// ===== SAFETY INDEX =====
let currentSort = 'score';

function renderIndex(sortBy) {
  window._indexInit = true;
  sortBy = sortBy || 'score';
  const container = document.getElementById('index-chart');

  let entries = Object.entries(NEIGHBORHOODS).map(([name, d]) => ({ name, ...d }));

  if (sortBy === 'score') entries.sort((a, b) => b.spi - a.spi);
  else if (sortBy === 'alpha') entries.sort((a, b) => a.name.localeCompare(b.name));
  else if (sortBy === 'uncertainty') entries.sort((a, b) => b.sigma - a.sigma);

  container.innerHTML = entries.map(d => {
    const pct = d.spi;
    const ciLeft = (d.ci_lo / 100) * 100;
    const ciWidth = ((d.ci_hi - d.ci_lo) / 100) * 100;
    return `
      <div class="bar-row">
        <div class="bar-label">${d.name}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width: ${pct}%; background: ${getSPIColor(d.spi)};"></div>
          <div class="bar-ci" style="left: ${ciLeft}%; width: ${ciWidth}%;"></div>
        </div>
        <div class="bar-value">${d.spi.toFixed(1)} ¬± ${d.sigma.toFixed(1)}</div>
      </div>`;
  }).join('');
}

function sortIndex(by) {
  currentSort = by;
  document.getElementById('sort-score').style.opacity = by === 'score' ? 1 : 0.5;
  document.getElementById('sort-alpha').style.opacity = by === 'alpha' ? 1 : 0.5;
  document.getElementById('sort-uncertainty').style.opacity = by === 'uncertainty' ? 1 : 0.5;
  renderIndex(by);
}

// ===== QUADRANT MATRIX =====
function renderQuadrant() {
  window._quadInit = true;
  const canvas = document.getElementById('quadrant-canvas');
  const ctx = canvas.getContext('2d');

  // Set actual pixel dimensions
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const w = rect.width, h = rect.height;
  const pad = 60;

  // Clear
  ctx.fillStyle = '#111827';
  ctx.fillRect(0, 0, w, h);

  const midX = pad + (w - 2 * pad) / 2;
  const midY = pad + (h - 2 * pad) / 2;

  // Quadrant backgrounds
  // Top-right: Thriving
  ctx.fillStyle = 'rgba(16, 185, 129, 0.08)';
  ctx.fillRect(midX, pad, w - pad - midX, midY - pad);

  // Top-left: Fragile
  ctx.fillStyle = 'rgba(139, 92, 246, 0.08)';
  ctx.fillRect(pad, pad, midX - pad, midY - pad);

  // Bottom-right: Hidden Risk
  ctx.fillStyle = 'rgba(245, 158, 11, 0.08)';
  ctx.fillRect(midX, midY, w - pad - midX, h - pad - midY);

  // Bottom-left: Crisis
  ctx.fillStyle = 'rgba(239, 68, 68, 0.08)';
  ctx.fillRect(pad, midY, midX - pad, h - pad - midY);

  // Axes
  ctx.strokeStyle = '#2a3d60';
  ctx.lineWidth = 1;
  ctx.setLineDash([4, 4]);
  ctx.beginPath();
  ctx.moveTo(midX, pad); ctx.lineTo(midX, h - pad);
  ctx.moveTo(pad, midY); ctx.lineTo(w - pad, midY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Axis labels
  ctx.fillStyle = '#5a6a8a';
  ctx.font = '12px DM Sans, sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Observed Safety Outcomes ‚Üí', w / 2, h - 15);
  ctx.save();
  ctx.translate(15, h / 2);
  ctx.rotate(-Math.PI / 2);
  ctx.fillText('Perceived Safety ‚Üí', 0, 0);
  ctx.restore();

  // Quadrant labels
  ctx.font = '600 13px DM Sans, sans-serif';
  ctx.fillStyle = 'rgba(139, 92, 246, 0.4)';
  ctx.fillText('FRAGILE', (pad + midX) / 2, pad + 24);
  ctx.fillStyle = 'rgba(16, 185, 129, 0.4)';
  ctx.fillText('THRIVING', (midX + w - pad) / 2, pad + 24);
  ctx.fillStyle = 'rgba(239, 68, 68, 0.4)';
  ctx.fillText('CRISIS', (pad + midX) / 2, h - pad - 12);
  ctx.fillStyle = 'rgba(245, 158, 11, 0.4)';
  ctx.fillText('HIDDEN RISK', (midX + w - pad) / 2, h - pad - 12);

  // Plot neighborhoods
  const notable = ['Tenderloin', 'Pacific Heights', 'Mission', 'Marina', 'South of Market',
    'Financial District', 'Presidio', 'Bayview Hunters Point', 'Castro/Upper Market', 'Noe Valley',
    'Chinatown', 'Western Addition', 'Russian Hill', 'Haight Ashbury'];

  const hiddenRisk = [];
  const fragile = [];

  for (const [name, data] of Object.entries(NEIGHBORHOODS)) {
    const x = pad + (data.outcome / 100) * (w - 2 * pad);
    const y = h - pad - (data.impact / 100) * (h - 2 * pad);

    let color;
    if (data.outcome >= 50 && data.impact >= 50) color = '#10b981';
    else if (data.outcome >= 50 && data.impact < 50) { color = '#f59e0b'; hiddenRisk.push(name); }
    else if (data.outcome < 50 && data.impact >= 50) { color = '#8b5cf6'; fragile.push(name); }
    else color = '#ef4444';

    // Dot
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.lineWidth = 1;
    ctx.stroke();

    // Label
    if (notable.includes(name)) {
      ctx.fillStyle = '#c8d6e8';
      ctx.font = '11px DM Sans, sans-serif';
      ctx.textAlign = 'left';
      const shortName = name.length > 18 ? name.slice(0, 16) + '‚Ä¶' : name;
      ctx.fillText(shortName, x + 10, y + 4);
    }
  }

  // Populate lists
  document.getElementById('hidden-risk-list').innerHTML = hiddenRisk.length > 0
    ? hiddenRisk.map(n => `‚Ä¢ ${n} (outcome: ${NEIGHBORHOODS[n].outcome}, perception: ${NEIGHBORHOODS[n].impact})`).join('<br>')
    : 'No neighborhoods in this quadrant with current data.';
  document.getElementById('fragile-list').innerHTML = fragile.length > 0
    ? fragile.map(n => `‚Ä¢ ${n} (outcome: ${NEIGHBORHOODS[n].outcome}, perception: ${NEIGHBORHOODS[n].impact})`).join('<br>')
    : 'No neighborhoods in this quadrant with current data.';
}

// ===== HOW IT WORKS =====
function renderMethods() {
  window._methodsInit = true;

  // Layer diagram
  const layers = [
    { id: 'L1', name: 'Incidents', weight: '20%', color: '#ef4444', components: 'Crime, Pedestrian Safety, Emergency' },
    { id: 'L2', name: 'Conditions', weight: '40%', color: '#f59e0b', components: 'Disorder, Lighting, Noise, Waste, Environment, Resolution' },
    { id: 'L3', name: 'Activity', weight: '13%', color: '#06b6d4', components: 'Transit, Cycling, Temporal Risk' },
    { id: 'L4', name: 'Environment', weight: '8%', color: '#10b981', components: 'Weather, Daylight, AQI (zeroed ‚Äî no neighborhood variance)' },
    { id: 'L5', name: 'Economy', weight: '9%', color: '#8b5cf6', components: 'Business Vitality, Food/Drink, Permits, Events' },
    { id: 'L6', name: 'Perception', weight: '9%', color: '#3b82f6', components: 'Review Sentiment, Community, Digital Concern (partially zeroed)' }
  ];

  document.getElementById('layer-diagram').innerHTML = layers.map(l => `
    <div style="display: flex; align-items: center; gap: 16px; padding: 12px 0; border-bottom: 1px solid rgba(30,45,74,0.3);">
      <div style="width: 50px; height: 50px; border-radius: 10px; background: ${l.color}20; border: 2px solid ${l.color}40; display: flex; align-items: center; justify-content: center; font-family: var(--font-mono); font-size: 13px; font-weight: 600; color: ${l.color}; flex-shrink: 0;">${l.id}</div>
      <div style="flex: 1;">
        <div style="font-weight: 600; font-size: 15px;">${l.name} <span style="font-family: var(--font-mono); font-size: 12px; color: var(--text-muted); font-weight: 400;">${l.weight}</span></div>
        <div style="font-size: 13px; color: var(--text-secondary);">${l.components}</div>
      </div>
      <div style="width: ${parseInt(l.weight) * 3}px; height: 8px; background: ${l.color}40; border-radius: 4px; flex-shrink: 0;">
        <div style="width: 100%; height: 100%; background: ${l.color}; border-radius: 4px;"></div>
      </div>
    </div>
  `).join('');

  // Feature importance
  const maxFI = Math.max(...FEATURE_IMPORTANCE.map(f => f.value));
  document.getElementById('feature-importance-chart').innerHTML = FEATURE_IMPORTANCE.map(f => `
    <div class="fi-bar-container">
      <div class="fi-label">${f.name}</div>
      <div class="fi-bar">
        <div class="fi-fill" style="width: ${(f.value / maxFI) * 100}%; background: ${LAYER_COLORS[f.layer]};"></div>
      </div>
      <div class="fi-value">+${f.value.toFixed(1)}</div>
    </div>
  `).join('');

  // Validation table
  document.getElementById('validation-table').innerHTML = `
    <table class="data-table">
      <thead>
        <tr><th>Neighborhood</th><th>SPI Score</th><th>¬± œÉ</th><th>95% CI</th><th>Target Range</th><th>Status</th></tr>
      </thead>
      <tbody>
        ${VALIDATION.map(v => `
          <tr>
            <td>${v.name}</td>
            <td style="font-family: var(--font-mono);">${v.score.toFixed(1)}</td>
            <td style="font-family: var(--font-mono);">¬± ${v.sigma.toFixed(1)}</td>
            <td style="font-family: var(--font-mono);">${v.ci}</td>
            <td style="font-family: var(--font-mono);">${v.target}</td>
            <td>${v.pass === true ? '<span class="validation-badge pass">‚úì Pass</span>' :
                  v.pass === false ? '<span class="validation-badge" style="background: rgba(239,68,68,0.12); color: #ef4444; border: 1px solid rgba(239,68,68,0.25);">‚úó Fail</span>' :
                  '<span class="validation-badge info">‚Äî Skip</span>'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
}

// ===== CITYBEAT TREND CHART =====
function renderCityBeatTrends() {
  const canvas = document.getElementById('citybeat-trends');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const w = rect.width, h = rect.height;
  const pad = { top: 20, right: 30, bottom: 40, left: 50 };

  // Data: CityBeat 2020-2026
  const years = ['2020', '2021', '2022', '2023', '2024', '2025', '2026'];
  const series = [
    { name: 'Right Direction', color: '#10b981', data: [20, 26, 20, 17, 22, 43, 64] },
    { name: 'Safe Downtown Day', color: '#3b82f6', data: [null, null, null, 64, 61, 69, 83] },
    { name: 'Safe Downtown Night', color: '#f59e0b', data: [null, null, null, 30, 34, 37, 51] },
    { name: 'Crime Getting Worse', color: '#ef4444', data: [65, null, 83, 77, 70, 49, 19] }
  ];

  ctx.fillStyle = '#111827';
  ctx.fillRect(0, 0, w, h);

  const plotW = w - pad.left - pad.right;
  const plotH = h - pad.top - pad.bottom;

  // Grid
  ctx.strokeStyle = 'rgba(30,45,74,0.4)';
  ctx.lineWidth = 0.5;
  for (let pct = 0; pct <= 100; pct += 20) {
    const y = pad.top + plotH - (pct / 100) * plotH;
    ctx.beginPath();
    ctx.moveTo(pad.left, y);
    ctx.lineTo(w - pad.right, y);
    ctx.stroke();
    ctx.fillStyle = '#5a6a8a';
    ctx.font = '11px DM Mono, monospace';
    ctx.textAlign = 'right';
    ctx.fillText(pct + '%', pad.left - 8, y + 4);
  }

  // X labels
  ctx.textAlign = 'center';
  ctx.fillStyle = '#5a6a8a';
  ctx.font = '12px DM Sans, sans-serif';
  years.forEach((yr, i) => {
    const x = pad.left + (i / (years.length - 1)) * plotW;
    ctx.fillText(yr, x, h - pad.bottom + 20);
    if (yr === '2026') {
      ctx.fillStyle = '#e8edf5';
      ctx.font = '600 12px DM Sans, sans-serif';
      ctx.fillText('2026', x, h - pad.bottom + 20);
      ctx.fillStyle = '#5a6a8a';
      ctx.font = '12px DM Sans, sans-serif';
    }
  });

  // Draw lines
  series.forEach(s => {
    ctx.strokeStyle = s.color;
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    let started = false;
    s.data.forEach((val, i) => {
      if (val === null) { started = false; return; }
      const x = pad.left + (i / (years.length - 1)) * plotW;
      const y = pad.top + plotH - (val / 100) * plotH;
      if (!started) { ctx.moveTo(x, y); started = true; }
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // Dots
    s.data.forEach((val, i) => {
      if (val === null) return;
      const x = pad.left + (i / (years.length - 1)) * plotW;
      const y = pad.top + plotH - (val / 100) * plotH;
      ctx.beginPath();
      ctx.arc(x, y, i === years.length - 1 ? 5 : 3, 0, Math.PI * 2);
      ctx.fillStyle = s.color;
      ctx.fill();
      // Label the 2026 point
      if (i === years.length - 1) {
        ctx.fillStyle = s.color;
        ctx.font = '600 12px DM Mono, monospace';
        ctx.textAlign = 'left';
        ctx.fillText(val + '%', x + 8, y + 4);
      }
    });
  });
}

// Render CityBeat chart on load
setTimeout(renderCityBeatTrends, 100);

// ===== RESIZE HANDLER =====
window.addEventListener('resize', () => {
  if (window._quadInit) {
    setTimeout(renderQuadrant, 100);
  }
  setTimeout(renderCityBeatTrends, 100);
});
</script>

</body>
</html>
