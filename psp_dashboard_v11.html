<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Public Safety Pulse</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,500;0,6..72,600;1,6..72,300;1,6..72,400&family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#fafaf8;--bg-warm:#f5f3ef;--bg-card:#fff;--bg-dark:#1c1917;--border:#e7e5e0;--text:#1c1917;--text-2:#57534e;--text-3:#a8a29e;--accent:#b45309;--blue:#1e40af;--red:#b91c1c;--green:#166534;--serif:'Newsreader',Georgia,serif;--sans:'Outfit',system-ui,sans-serif;--mono:'JetBrains Mono','Menlo',monospace}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:var(--sans);background:var(--bg);color:var(--text);line-height:1.65;-webkit-font-smoothing:antialiased}
.container{max-width:820px;margin:0 auto;padding:0 24px}
.wide{max-width:1080px;margin:0 auto;padding:0 24px}
section{padding:72px 0;border-bottom:1px solid var(--border);scroll-margin-top:100px}
section:last-of-type{border-bottom:none}
.topbar{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--text-3);background:var(--bg);position:sticky;top:0;z-index:100}
.topbar b{color:var(--text);letter-spacing:-0.3px}
.topbar span{font-family:var(--mono);font-size:11px}
.hero{padding:100px 0 80px;border-bottom:1px solid var(--border)}
.hero-label{font-family:var(--mono);font-size:12px;letter-spacing:2px;text-transform:uppercase;color:var(--accent);margin-bottom:20px}
.hero h1{font-family:var(--serif);font-size:clamp(36px,5vw,56px);font-weight:400;line-height:1.15;letter-spacing:-1px;max-width:700px;margin-bottom:24px}
.hero-body{font-size:18px;color:var(--text-2);max-width:600px;line-height:1.7}
.slabel{font-family:var(--mono);font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text-3);margin-bottom:12px}
h2{font-family:var(--serif);font-size:32px;font-weight:400;line-height:1.25;letter-spacing:-0.5px;margin-bottom:16px}
.sbody{font-size:16px;color:var(--text-2);max-width:620px;margin-bottom:32px}
.egrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin:32px 0}
.ecard{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:24px 20px}
.ecard .num{font-family:var(--serif);font-size:40px;font-weight:300;letter-spacing:-2px;line-height:1;margin-bottom:6px}
.ecard .lbl{font-size:13px;color:var(--text-2);line-height:1.4}
.ecard .src{font-family:var(--mono);font-size:10px;color:var(--text-3);margin-top:8px}
.loop{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;margin:40px 0;background:var(--border);border-radius:8px;overflow:hidden}
.loop-s{background:var(--bg-card);padding:28px 20px;text-align:center}
.loop-s .sn{font-family:var(--mono);font-size:11px;color:var(--text-3);margin-bottom:8px}
.loop-s .st{font-family:var(--serif);font-size:20px;font-weight:500;margin-bottom:8px}
.loop-s .sb{font-size:13px;color:var(--text-2);line-height:1.5}
@media(max-width:640px){.loop{grid-template-columns:1fr 1fr}}
.mapsec{background:var(--bg-dark);padding:64px 0;border-bottom:none}
.mapsec h2,.mapsec .slabel{color:#e7e5e0}
.mapsec .sbody,.mapsec .slabel{color:#a8a29e}
.mapsec .slabel{color:#78716c}
#mc{height:520px;border-radius:8px;overflow:hidden;border:1px solid #292524;margin-top:24px}
.mbar{display:flex;align-items:center;gap:12px;margin-top:16px}
.msel{padding:7px 14px;background:#292524;border:1px solid #44403c;border-radius:6px;color:#e7e5e0;font-family:var(--sans);font-size:13px;cursor:pointer}
.mnote{font-size:12px;color:#78716c;margin-left:auto;font-family:var(--mono)}
.mleg{display:flex;align-items:center;gap:12px;margin-top:12px}
.lgrad{flex:1;max-width:300px;height:8px;border-radius:4px;background:linear-gradient(90deg,#b91c1c,#d97706,#65a30d,#166534)}
.leaflet-container{background:#1c1917!important}
.leaflet-popup-content-wrapper{background:#292524!important;color:#e7e5e0!important;border-radius:8px!important;box-shadow:0 8px 32px rgba(0,0,0,.4)!important;border:1px solid #44403c!important}
.leaflet-popup-tip{background:#292524!important}
.leaflet-popup-content{font-family:var(--sans)!important;font-size:13px!important;margin:14px 16px!important}
.leaflet-control-zoom a{background:#292524!important;color:#e7e5e0!important;border-color:#44403c!important}
.leaflet-control-attribution{display:none!important}
.pn{font-family:var(--serif);font-size:18px;font-weight:500;margin-bottom:4px}
.ps{font-family:var(--mono);font-size:28px;font-weight:600;line-height:1}
.pc{font-family:var(--mono);font-size:12px;color:#a8a29e;margin-top:2px}
.pd{font-size:12px;color:#a8a29e;margin-top:10px;padding-top:8px;border-top:1px solid #44403c;line-height:1.8}
.mgrid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:32px 0}
@media(max-width:640px){.mgrid{grid-template-columns:1fr}}
.mcard{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:24px}
.mcard h3{font-family:var(--serif);font-size:18px;font-weight:500;margin-bottom:12px}
.mcard p{font-size:14px;color:var(--text-2);line-height:1.6}
.fir{display:flex;align-items:center;gap:12px;padding:8px 0}
.fin{width:170px;font-size:13px;color:var(--text-2);text-align:right;flex-shrink:0}
.fit{flex:1;height:16px;background:var(--bg-warm);border-radius:3px;overflow:hidden}
.fif{height:100%;border-radius:3px}
.fiv{width:44px;font-family:var(--mono);font-size:12px;color:var(--text-3)}
.vtb{width:100%;border-collapse:collapse;font-size:14px;margin:16px 0}
.vtb th{text-align:left;padding:10px 12px;font-family:var(--mono);font-size:11px;letter-spacing:.5px;text-transform:uppercase;color:var(--text-3);border-bottom:2px solid var(--border)}
.vtb td{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text-2)}
.vtb td:nth-child(2),.vtb td:nth-child(3),.vtb td:nth-child(4){font-family:var(--mono);font-size:13px}
.bp{display:inline-block;font-family:var(--mono);font-size:11px;padding:2px 8px;border-radius:4px;background:#dcfce7;color:var(--green);font-weight:500}
.bs{display:inline-block;font-family:var(--mono);font-size:11px;padding:2px 8px;border-radius:4px;background:var(--bg-warm);color:var(--text-3)}
.co{background:var(--bg-card);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;padding:20px 24px;margin:24px 0}
.co p{font-size:14px;color:var(--text-2);line-height:1.7}
.co strong{color:var(--text)}
.lim{padding:12px 0;border-bottom:1px solid var(--border);display:grid;grid-template-columns:160px 1fr;gap:16px;font-size:14px}
.lim:last-child{border-bottom:none}
.lim .ln{font-weight:500;color:var(--text)}
.lim .ld{color:var(--text-2)}
.prow{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:var(--border);border-radius:8px;overflow:hidden;margin:32px 0}
@media(max-width:640px){.prow{grid-template-columns:1fr}}
.pcrd{background:var(--bg-card);padding:28px 24px}
.pcrd .pl{font-family:var(--mono);font-size:11px;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px}
.pcrd h3{font-family:var(--serif);font-size:20px;font-weight:500;margin-bottom:10px}
.pcrd p{font-size:14px;color:var(--text-2);line-height:1.6}
.pill{display:inline-block;font-family:var(--mono);font-size:11px;padding:2px 8px;border-radius:4px;background:var(--bg-warm);color:var(--text-3);margin:2px 2px 2px 0}
footer{padding:48px 0;text-align:center;color:var(--text-3);font-size:14px}
footer strong{color:var(--text-2)}
@keyframes fu{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.a{animation:fu .5s ease forwards;opacity:0}.d1{animation-delay:.05s}.d2{animation-delay:.1s}.d3{animation-delay:.15s}
.secnav{position:sticky;top:47px;z-index:99;background:var(--bg);border-bottom:1px solid var(--border);padding:8px 24px}
.secnav::-webkit-scrollbar{display:none}
.sn-link{font-family:var(--mono);font-size:11px;letter-spacing:.3px;color:var(--text-3);text-decoration:none;padding:6px 12px;border-radius:4px;white-space:nowrap;transition:all .15s}
.sn-link:hover{color:var(--text-2);background:var(--bg-warm)}
.sn-link.active{color:var(--accent);background:rgba(180,83,9,.08)}
</style>
</head>
<body>

<div class="topbar">
  <b>Public Safety Pulse</b>
  <span>City Science Lab SF × MIT Media Lab · Internal Review · Feb 2026</span>
</div>
<nav class="secnav" id="secnav">
  <div class="wide" style="display:flex;gap:4px;overflow-x:auto;scrollbar-width:none">
    <a href="#s1" class="sn-link active">01 Challenge</a>
    <a href="#s2" class="sn-link">02 North Star</a>
    <a href="#s3" class="sn-link">03 Where We Are</a>
    <a href="#s4" class="sn-link">04 Science</a>
    <a href="#s5" class="sn-link">05 Direct Measurement</a>
    <a href="#s6" class="sn-link">06 What's Next</a>
  </div>
</nav>

<div class="hero">
  <div class="container">
    <div class="hero-label a">City Science Lab San Francisco</div>
    <h1 class="a d1">Measuring how safe people <em>feel</em>, block&nbsp;by&nbsp;block, shift&nbsp;by&nbsp;shift</h1>
    <p class="hero-body a d2">Safety perception in San Francisco is complex and shifting. Downtown perception has improved — 78% feel safe during the day per CityBeat 2025 — but city-wide night safety remains low at 36%. Different surveys, different geographies, different times of day tell different stories. That inconsistency is itself the problem: the city has no consistent, high-frequency way to know how people feel, where, and whether that's changing.</p>
  </div>
</div>

<section id="s1">
  <div class="container">
    <div class="slabel">01 — The Challenge</div>
    <h2>The city can't measure how safe people feel — consistently, frequently, or granularly</h2>
    <p class="sbody">The City Survey runs every two years at neighborhood level. CityBeat polls downtown visitors quarterly. SFMTA surveys transit riders occasionally. Each tells a different story. None operates at the frequency or granularity needed to target interventions or measure their impact. The result: policies are designed around lagging incident data, not the lived experience of residents and visitors.</p>
    <div class="egrid">
      <div class="ecard"><div class="num" style="color:var(--accent)">78%</div><div class="lbl">of downtown visitors feel safe during the day</div><div class="src">CityBeat 2025</div></div>
      <div class="ecard"><div class="num" style="color:var(--red)">36%</div><div class="lbl">of residents feel safe walking alone at night, city-wide</div><div class="src">SF City Survey 2023</div></div>
      <div class="ecard"><div class="num" style="color:var(--green)">43%</div><div class="lbl">say SF is on the right track (up from 22%)</div><div class="src">CityBeat 2025</div></div>
      <div class="ecard"><div class="num" style="color:var(--blue)">0</div><div class="lbl">tools that measure perception at block level, at shift frequency</div><div class="src">Current state</div></div>
    </div>
  </div>
</section>

<section id="s2">
  <div class="container">
    <div class="slabel">02 — The North Star</div>
    <h2>A correlation machine for safety perception</h2>
    <p class="sbody">If we can measure how people feel about safety at the block level, at shift frequency, then we can do something no city has done: see where concern is rising, understand what drives it, deploy targeted interventions, and measure whether those interventions actually changed how people feel.</p>
  </div>
  <div class="wide">
    <div class="loop">
      <div class="loop-s"><div class="sn">01</div><div class="st">Sense</div><div class="sb">Measure perception at block level, shift frequency. Fuse administrative data with direct sentiment signals.</div></div>
      <div class="loop-s"><div class="sn">02</div><div class="st">Correlate</div><div class="sb">Build statistical relationships between conditions, interventions, and perception changes.</div></div>
      <div class="loop-s"><div class="sn">03</div><div class="st">Act</div><div class="sb">Deploy interventions where concern is rising. Lighting, ambassadors, activation — targeted by signal.</div></div>
      <div class="loop-s"><div class="sn">04</div><div class="st">Measure</div><div class="sb">Track perception change after intervention. Did it work? For whom? Close the feedback loop.</div></div>
    </div>
  </div>
</section>

<section class="mapsec" id="s3">
  <div class="wide">
    <div class="slabel">03 — Where We Are</div>
    <h2>Phase 0: A perception proxy from public data</h2>
    <p class="sbody">We fused 36 public data sources — 3.2 million records — into a neighborhood-level Safety Perception Index. The core signal comes from incident reports (SFPD, fire/EMS), conditions data (311 complaints, streetlight outages), and activity patterns (transit ridership, cycling). Contextual data (permits, business activity, review sentiment) adds signal but is not direct safety measurement. The model is calibrated against City Survey ground truth using Gaussian Process regression.</p>
    <div class="mbar">
      <select class="msel" id="mls"><option value="spi">Overall SPI</option><option value="l1">L1 — Incidents</option><option value="l2">L2 — Conditions</option><option value="l3">L3 — Activity</option><option value="l5">L5 — Economy</option><option value="l6">L6 — Perception</option></select>
      <span class="mnote">Click any area for score + confidence interval</span>
    </div>
    <div id="mc"></div>
    <div class="mleg">
      <span style="font-size:11px;color:#78716c;font-family:var(--mono)">SPI</span>
      <div class="lgrad"></div>
      <div style="display:flex;justify-content:space-between;width:300px"><span style="font-size:11px;color:#78716c;font-family:var(--mono)">10</span><span style="font-size:11px;color:#78716c;font-family:var(--mono)">50</span><span style="font-size:11px;color:#78716c;font-family:var(--mono)">90</span></div>
    </div>
  </div>
</section>

<section id="s4">
  <div class="container">
    <div class="slabel">04 — The Science</div>
    <h2>Gaussian Process regression with uncertainty quantification</h2>
    <p class="sbody">With 38 ground-truth labels and 18 features, we need a model that's honest about what it knows and what it doesn't. GP regression produces a prediction and a confidence interval for every neighborhood.</p>
    <div class="mgrid">
      <div class="mcard"><h3>Model specification</h3><p><span style="font-family:var(--mono);font-size:13px;color:var(--accent)">SPI(x) = μ(x) ± σ(x)</span><br><br>Kernel: RBF (ℓ=5.0, σ²=400) + noise=50. Hyperparameters optimized via log marginal likelihood. Density features log-transformed per Weber-Fechner law.</p></div>
      <div class="mcard"><h3>Why Gaussian Process?</h3><p>38 labels, 18 features. Anything beyond regularized regression overfits. GP chosen because it's Bayesian (uncertainty, not just point estimates), nonparametric (no functional form assumptions), and honest (wide intervals where data is sparse).</p></div>
    </div>
    <div class="egrid" style="margin-top:24px">
      <div class="ecard"><div class="num" style="font-family:var(--mono);font-size:28px;color:var(--blue)">0.896</div><div class="lbl">In-sample R² — explains 90% of perception variance</div></div>
      <div class="ecard"><div class="num" style="font-family:var(--mono);font-size:28px;color:var(--accent)">11.1</div><div class="lbl">Leave-one-out CV RMSE — honest out-of-sample error</div></div>
      <div class="ecard"><div class="num" style="font-family:var(--mono);font-size:28px;color:var(--green)">9 / 9</div><div class="lbl">Validation neighborhoods within target range</div></div>
      <div class="ecard"><div class="num" style="font-family:var(--mono);font-size:28px;color:var(--text-3)">± 4.8</div><div class="lbl">Mean predictive σ — average confidence interval</div></div>
    </div>

    <h3 style="font-family:var(--serif);font-size:22px;margin:40px 0 8px">What predicts perceived safety?</h3>
    <p style="font-size:14px;color:var(--text-2);margin-bottom:20px">Permutation feature importance: model accuracy loss when each feature is shuffled.</p>
    <div id="fic"></div>
    <div class="co" style="margin-top:24px"><p><strong>Interpretation note:</strong> With only 38 training samples, feature importance rankings are unstable — a few different labels could shift the order. That said, the pattern is suggestive: visible investment and environmental conditions appear alongside incident data as predictors. This is consistent with the literature on environmental perception (Broken Windows, CPTED) but should be validated with larger samples in Phase 1.</p></div>

    <h3 style="font-family:var(--serif);font-size:22px;margin:40px 0 8px">Validation against ground truth</h3>
    <p style="font-size:14px;color:var(--text-2);margin-bottom:16px">Model scores compared against SF City Survey 2023 and Niche.com safety grades.</p>
    <table class="vtb"><thead><tr><th>Neighborhood</th><th>SPI ± σ</th><th>95% CI</th><th>Target</th><th>Result</th></tr></thead><tbody id="vb"></tbody></table>

    <h3 style="font-family:var(--serif);font-size:22px;margin:40px 0 8px">Known limitations</h3>
    <p style="font-size:14px;color:var(--text-2);margin-bottom:16px">Presented with the same rigor we apply to the model outputs.</p>
    <div class="lim"><div class="ln">Reporting bias</div><div class="ld">311 usage correlates with tech literacy, language proficiency, and trust in government. Communities that don't report are invisible to administrative data.</div></div>
    <div class="lim"><div class="ln">Survival bias</div><div class="ld">People who feel most unsafe avoid an area entirely, leaving no data trace. The most important perception signal is absence.</div></div>
    <div class="lim"><div class="ln">Data density gaps</div><div class="ld">Neighborhoods with fewer administrative records produce weaker model signal. The model's confidence intervals are widest where data is sparsest — not necessarily where safety is worst.</div></div>
    <div class="lim"><div class="ln">Small sample</div><div class="ld">38 ground truth labels restricts methodology to regularized regression. Deep learning requires orders of magnitude more labeled data — which Phase 1 provides.</div></div>
    <div class="lim"><div class="ln">Proxy, not measurement</div><div class="ld">Every component approximates perception. None measures it directly. Phase 0 exists to prove the signal is real and quantify how much better direct measurement would be.</div></div>
  </div>
</section>

<section id="s5">
  <div class="container">
    <div class="slabel">05 — Direct Measurement</div>
    <h2>One question, asked often, at the point of experience</h2>
    <p class="sbody">Everything in Phase 0 is proxy data — administrative records that approximate how people feel. Phase 1 replaces approximation with direct measurement: a single perception question deployed on existing digital touchpoints at the moment someone is in a place.</p>
    <div class="co"><p><strong>The question:</strong> <em>"Right now, how does the surrounding area feel to you?"</em> — collected via POS terminals, Clipper kiosks, visitor check-in systems (Envoy), transit apps, and CBD ambassador tablets. Geolocated. Timestamped. Aggregated to protect privacy. Designed to complement — not replace — 911, 311, and surveys.</p></div>
    <div class="mgrid">
      <div class="mcard"><h3>Why existing touchpoints</h3><p>No new app. No survey fatigue. The question meets people where they already are: paying for coffee, tapping into BART, checking into a building. 5K responses/month in month 1, scaling to 50K by month 6 across transit, retail, and office touchpoints.</p></div>
      <div class="mcard"><h3>What this enables</h3><p>Block-level perception data at shift frequency. For the first time: deploy a lighting intervention on Tuesday, measure perception change by Friday. See whether a new ambassador route actually changes how people feel on that corridor. Close the feedback loop that doesn't exist today.</p></div>
    </div>
    <div class="egrid">
      <div class="ecard"><div class="num" style="color:var(--accent)">1</div><div class="lbl">question — takes 2 seconds to answer</div></div>
      <div class="ecard"><div class="num" style="color:var(--blue)">50K</div><div class="lbl">responses/month target by month 6</div><div class="src">PSP Phase 1 proposal</div></div>
      <div class="ecard"><div class="num" style="color:var(--green)">Block</div><div class="lbl">level granularity, geolocated + timestamped</div></div>
      <div class="ecard"><div class="num" style="color:var(--red)">Shift</div><div class="lbl">frequency updates — morning vs evening vs night</div></div>
    </div>
  </div>
</section>

<section id="s6">
  <div class="container">
    <div class="slabel">06 — What Comes Next</div>
    <h2>Phased approach: proxy → AI → real-time network</h2>
    <p class="sbody">Phase 0 proves the concept with public data. Phase 1 adds AI-powered perception signals and direct measurement. Phase 2 builds the real-time correlation machine.</p>
  </div>
  <div class="wide">
    <div class="prow">
      <div class="pcrd"><div class="pl" style="color:var(--accent)">Phase 0 — Complete</div><h3>Data Fusion Baseline</h3><p>36 sources, 3.2M records. GP regression calibrated against City Survey. Neighborhood-level SPI with uncertainty quantification.</p><div style="margin-top:12px"><span class="pill">R²=0.896</span><span class="pill">38 labels</span><span class="pill">18 features</span></div></div>
      <div class="pcrd"><div class="pl" style="color:var(--blue)">Phase 1 — Proposed</div><h3>Multimodal Perception AI</h3><p>NLP on 500K reviews via Gemini. Computer vision on 30K street blocks via Vision API. Direct perception collection via transit touchpoints. Block-level resolution.</p><div style="margin-top:12px"><span class="pill">Gemini</span><span class="pill">Vision API</span><span class="pill">500K+ signals</span></div></div>
      <div class="pcrd"><div class="pl" style="color:var(--green)">Phase 2 — Target</div><h3>The Correlation Machine</h3><p>Continuous signal from transit touchpoints. 50K responses/month. Shift-frequency updates. Intervention impact measurement. Block-by-block outcomes.</p><div style="margin-top:12px"><span class="pill">50K/month</span><span class="pill">Block level</span><span class="pill">Shift frequency</span></div></div>
    </div>
  </div>
</section>

<footer>
  <div class="container">
    <strong>City Science Lab San Francisco × MIT Media Lab City Science</strong><br>
    <span style="font-size:13px">Building on the lineage of MIT Place Pulse — evolving static perception scoring into dynamic, continuous, multi-signal measurement.</span>
  </div>
</footer>

<script>
const N={"Tenderloin":{spi:21.4,s:5.5,lo:11,hi:32,l1:12,l2:15,l3:30,l5:25,l6:22},"South of Market":{spi:27.1,s:4.9,lo:17,hi:37,l1:22,l2:20,l3:35,l5:35,l6:28},"Mission":{spi:33.9,s:5.7,lo:23,hi:45,l1:28,l2:30,l3:40,l5:38,l6:35},"Chinatown":{spi:40.3,s:5.2,lo:30,hi:51,l1:32,l2:35,l3:42,l5:42,l6:38},"Bayview Hunters Point":{spi:43.5,s:5.2,lo:33,hi:54,l1:25,l2:32,l3:38,l5:30,l6:35},"Western Addition":{spi:46.5,s:4.8,lo:37,hi:56,l1:35,l2:38,l3:45,l5:40,l6:42},"Haight Ashbury":{spi:48.2,s:4.5,lo:39,hi:57,l1:38,l2:42,l3:48,l5:45,l6:44},"Hayes Valley":{spi:49.8,s:4.3,lo:41,hi:58,l1:40,l2:44,l3:50,l5:52,l6:46},"McLaren Park":{spi:50.2,s:5.0,lo:40,hi:60,l1:42,l2:45,l3:44,l5:38,l6:40},"North Beach":{spi:51.5,s:4.2,lo:43,hi:60,l1:42,l2:48,l3:55,l5:56,l6:50},"Financial District":{spi:52.3,s:4.0,lo:44,hi:60,l1:45,l2:50,l3:56,l5:58,l6:48},"Nob Hill":{spi:53.1,s:4.3,lo:44,hi:62,l1:46,l2:50,l3:52,l5:52,l6:52},"Outer Mission":{spi:53.4,s:4.6,lo:44,hi:63,l1:44,l2:48,l3:50,l5:45,l6:48},"Portola":{spi:54.2,s:4.8,lo:45,hi:64,l1:46,l2:50,l3:48,l5:44,l6:50},"Visitacion Valley":{spi:51.5,s:5.0,lo:42,hi:62,l1:38,l2:42,l3:45,l5:38,l6:42},"Excelsior":{spi:55.8,s:4.5,lo:47,hi:65,l1:48,l2:52,l3:50,l5:48,l6:52},"Oceanview/Merced/Ingleside":{spi:56.2,s:4.4,lo:47,hi:65,l1:48,l2:52,l3:50,l5:46,l6:50},"Japantown":{spi:57.5,s:4.0,lo:50,hi:66,l1:50,l2:54,l3:55,l5:55,l6:54},"Castro/Upper Market":{spi:58.4,s:3.8,lo:51,hi:66,l1:50,l2:55,l3:60,l5:62,l6:56},"Potrero Hill":{spi:59.6,s:3.9,lo:52,hi:67,l1:52,l2:56,l3:58,l5:60,l6:58},"Bernal Heights":{spi:61.2,s:3.8,lo:54,hi:69,l1:54,l2:58,l3:60,l5:62,l6:60},"Lone Mountain/USF":{spi:62.0,s:3.7,lo:55,hi:69,l1:55,l2:60,l3:58,l5:58,l6:60},"Glen Park":{spi:63.8,s:3.6,lo:57,hi:71,l1:58,l2:62,l3:60,l5:64,l6:64},"Russian Hill":{spi:66.1,s:3.9,lo:58,hi:74,l1:60,l2:64,l3:65,l5:68,l6:66},"Inner Richmond":{spi:66.5,s:3.5,lo:60,hi:74,l1:60,l2:65,l3:62,l5:60,l6:64},"Lakeshore":{spi:65.8,s:4.2,lo:57,hi:74,l1:58,l2:62,l3:58,l5:55,l6:62},"Marina":{spi:68.1,s:4.4,lo:59,hi:77,l1:62,l2:68,l3:68,l5:72,l6:68},"Inner Sunset":{spi:68.8,s:3.4,lo:62,hi:76,l1:62,l2:66,l3:64,l5:65,l6:68},"Outer Richmond":{spi:69.5,s:3.6,lo:62,hi:77,l1:62,l2:68,l3:62,l5:62,l6:68},"Lincoln Park":{spi:69.6,s:5.5,lo:59,hi:80,l1:72,l2:75,l3:55,l5:58,l6:70},"Sunset/Parkside":{spi:70.2,s:3.5,lo:63,hi:77,l1:64,l2:68,l3:64,l5:62,l6:70},"Outer Sunset":{spi:70.0,s:3.8,lo:62,hi:78,l1:64,l2:68,l3:62,l5:60,l6:70},"Twin Peaks":{spi:71.0,s:3.7,lo:64,hi:78,l1:65,l2:70,l3:62,l5:65,l6:72},"Pacific Heights":{spi:71.9,s:4.4,lo:63,hi:81,l1:68,l2:72,l3:68,l5:78,l6:74},"Noe Valley":{spi:73.0,s:3.6,lo:66,hi:80,l1:66,l2:72,l3:70,l5:76,l6:74},"West of Twin Peaks":{spi:73.2,s:3.6,lo:66,hi:80,l1:66,l2:72,l3:66,l5:68,l6:74},"Treasure Island":{spi:55.0,s:6.0,lo:43,hi:67,l1:50,l2:52,l3:40,l5:42,l6:48},"Presidio Heights":{spi:76.8,s:4.5,lo:68,hi:86,l1:72,l2:78,l3:70,l5:80,l6:78},"Seacliff":{spi:79.2,s:5.0,lo:69,hi:89,l1:74,l2:80,l3:68,l5:78,l6:82},"Presidio":{spi:79.6,s:5.7,lo:68,hi:91,l1:78,l2:82,l3:65,l5:70,l6:80},"Crocker Amazon":{spi:56.0,s:4.8,lo:47,hi:66,l1:48,l2:52,l3:48,l5:46,l6:50}};
const C={"Tenderloin":[37.7847,-122.4141],"South of Market":[37.7785,-122.3997],"Mission":[37.7599,-122.4148],"Chinatown":[37.7941,-122.4078],"Bayview Hunters Point":[37.7296,-122.3873],"Western Addition":[37.7811,-122.4355],"Haight Ashbury":[37.7695,-122.4483],"Hayes Valley":[37.7759,-122.4245],"McLaren Park":[37.7186,-122.4207],"North Beach":[37.8061,-122.4103],"Financial District":[37.7946,-122.3999],"Nob Hill":[37.793,-122.4161],"Outer Mission":[37.7234,-122.4435],"Portola":[37.7268,-122.4069],"Visitacion Valley":[37.7133,-122.4048],"Excelsior":[37.7262,-122.4293],"Oceanview/Merced/Ingleside":[37.7183,-122.4567],"Japantown":[37.7857,-122.4299],"Castro/Upper Market":[37.7609,-122.435],"Potrero Hill":[37.7585,-122.3927],"Bernal Heights":[37.7425,-122.4153],"Lone Mountain/USF":[37.7768,-122.452],"Glen Park":[37.7341,-122.4332],"Russian Hill":[37.8011,-122.4196],"Inner Richmond":[37.7787,-122.4634],"Marina":[37.8012,-122.4367],"Lakeshore":[37.7265,-122.4833],"Inner Sunset":[37.7576,-122.4683],"Outer Richmond":[37.7787,-122.4895],"Sunset/Parkside":[37.7528,-122.4931],"Twin Peaks":[37.7544,-122.4477],"Pacific Heights":[37.7925,-122.4382],"Noe Valley":[37.7502,-122.4337],"West of Twin Peaks":[37.7426,-122.4573],"Treasure Island":[37.8235,-122.3706],"Presidio Heights":[37.7875,-122.4509],"Seacliff":[37.7868,-122.4894],"Lincoln Park":[37.7847,-122.5033],"Presidio":[37.7989,-122.4662],"Outer Sunset":[37.7535,-122.505],"Crocker Amazon":[37.71,-122.435]};
const FI=[{n:"Construction Investment",v:8,c:"#92400e"},{n:"Crime Severity",v:4.58,c:"#b91c1c"},{n:"Noise & Disorder",v:3.87,c:"#d97706"},{n:"Pedestrian Safety",v:3.73,c:"#b91c1c"},{n:"Temporal Risk",v:3.49,c:"#0e7490"},{n:"Resolution Speed",v:3.42,c:"#d97706"},{n:"Disorder Density",v:3.18,c:"#d97706"},{n:"Lighting Risk",v:2.65,c:"#d97706"},{n:"Review Sentiment",v:2.44,c:"#1e40af"},{n:"Emergency Density",v:2.31,c:"#b91c1c"}];
const V=[{n:"Tenderloin",sc:21.4,s:5.5,ci:"11–32",t:"10–25",p:1},{n:"South of Market",sc:27.1,s:4.9,ci:"17–37",t:"25–45",p:1},{n:"Mission",sc:33.9,s:5.7,ci:"23–45",t:"30–50",p:1},{n:"Pacific Heights",sc:71.9,s:4.4,ci:"63–81",t:"70–90",p:1},{n:"Marina",sc:68.1,s:4.4,ci:"59–77",t:"65–85",p:1},{n:"Presidio",sc:79.6,s:5.7,ci:"68–91",t:"75–95",p:1},{n:"Noe Valley",sc:73,s:3.6,ci:"66–80",t:"65–85",p:1},{n:"Russian Hill",sc:66.1,s:3.9,ci:"58–74",t:"60–80",p:1},{n:"Outer Sunset",sc:70,s:3.8,ci:"62–78",t:"65–85",p:1}];

let map,gL,cL='spi';
function gc(s){return s<=25?'#b91c1c':s<=35?'#c2410c':s<=45?'#b45309':s<=55?'#a16207':s<=65?'#4d7c0f':s<=75?'#15803d':'#166534'}
function gs(d,l){return l==='l1'?d.l1:l==='l2'?d.l2:l==='l3'?d.l3:l==='l5'?d.l5:l==='l6'?d.l6:d.spi}
function mn(n){if(N[n])return N[n];const l=n.toLowerCase();for(const[k,v]of Object.entries(N)){if(k.toLowerCase()===l)return v;if(l.includes(k.toLowerCase().split('/')[0])||k.toLowerCase().includes(l.split('/')[0]))return v}return null}
function pp(n,d){return`<div class="pn">${n}</div><div class="ps" style="color:${gc(d.spi)}">${d.spi.toFixed(1)}</div><div class="pc">± ${d.s.toFixed(1)} · 95% CI [${d.lo}, ${d.hi}]</div><div class="pd">Incidents: ${d.l1} · Conditions: ${d.l2} · Activity: ${d.l3}<br>Economy: ${d.l5} · Perception: ${d.l6}</div>`}
function initMap(){
  map=L.map('mc',{center:[37.76,-122.44],zoom:12,zoomControl:true,attributionControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(map);
  (async()=>{for(const p of['data/sf_neighborhoods.geojson','sf_neighborhoods.geojson']){try{const r=await fetch(p);if(r.ok){const g=await r.json();if(g.features?.length){rP(g);return}}}catch(e){}}rC()})();
  document.getElementById('mls').addEventListener('change',e=>{cL=e.target.value;uC()});
}
function rP(g){gL=L.geoJSON(g,{style:f=>{const n=f.properties.nhood||f.properties.neighborhood||f.properties.name||'';const d=mn(n);return{fillColor:gc(d?gs(d,cL):50),fillOpacity:.65,color:'#1c1917',weight:1.2}},onEachFeature:(f,l)=>{const n=f.properties.nhood||f.properties.neighborhood||f.properties.name||'';const d=mn(n);if(d)l.bindPopup(pp(n,d));l.on('mouseover',function(){this.setStyle({fillOpacity:.85,weight:2})});l.on('mouseout',function(){this.setStyle({fillOpacity:.65,weight:1.2})})}}).addTo(map)}
function rC(){gL=L.layerGroup();for(const[n,co]of Object.entries(C)){const d=N[n];if(!d)continue;const c=L.circle(co,{radius:350+d.s*25,fillColor:gc(gs(d,cL)),fillOpacity:.7,color:'rgba(255,255,255,.12)',weight:1,_name:n});c.bindPopup(pp(n,d));c.on('mouseover',function(){this.setStyle({fillOpacity:.9,weight:2})});c.on('mouseout',function(){this.setStyle({fillOpacity:.7,weight:1})});gL.addLayer(c)}gL.addTo(map)}
function uC(){if(!gL)return;gL.eachLayer(l=>{const n=l.feature?(l.feature.properties.nhood||l.feature.properties.neighborhood||l.feature.properties.name||''):(l.options?._name||'');const d=mn(n);if(d)l.setStyle({fillColor:gc(gs(d,cL))})})}

// Feature importance
document.getElementById('fic').innerHTML=FI.map(f=>`<div class="fir"><div class="fin">${f.n}</div><div class="fit"><div class="fif" style="width:${(f.v/8)*100}%;background:${f.c}"></div></div><div class="fiv">+${f.v.toFixed(1)}</div></div>`).join('');

// Validation
document.getElementById('vb').innerHTML=V.map(v=>`<tr><td>${v.n}</td><td>${v.sc.toFixed(1)} ± ${v.s.toFixed(1)}</td><td>${v.ci}</td><td>${v.t}</td><td>${v.p?'<span class="bp">✓ Pass</span>':'<span class="bs">— Skip</span>'}</td></tr>`).join('');

// Lazy map init
const obs=new IntersectionObserver(e=>{if(e[0].isIntersecting&&!window._m){window._m=1;initMap()}},{threshold:.1});
obs.observe(document.getElementById('mc'));

// Section nav scroll tracking
const sections=document.querySelectorAll('section[id]');
const navLinks=document.querySelectorAll('.sn-link');
const secObs=new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      navLinks.forEach(l=>l.classList.remove('active'));
      const link=document.querySelector(`.sn-link[href="#${e.target.id}"]`);
      if(link)link.classList.add('active');
    }
  });
},{threshold:0.3,rootMargin:'-80px 0px -50% 0px'});
sections.forEach(s=>secObs.observe(s));

// Smooth scroll for nav links
navLinks.forEach(l=>{
  l.addEventListener('click',e=>{
    e.preventDefault();
    const target=document.querySelector(l.getAttribute('href'));
    if(target)target.scrollIntoView({behavior:'smooth',block:'start'});
  });
});
</script>
</body>
</html>
